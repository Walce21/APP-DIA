(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function o(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(a){if(a.ep)return;a.ep=!0;const i=o(a);fetch(a.href,i)}})();let d={originalImage:{src:null,fileName:""},offscreenCanvas:null,viewTransform:{scale:1,offsetX:0,offsetY:0,initialSetupDone:!1},currentTool:"pointer",isDrawing:!1,isPanning:!1,isDraggingRoi:!1,isResizingRoi:!1,drawingStartPos:{x:0,y:0},lastPanPosition:{x:0,y:0},resizeHandle:null,dragInitialState:null,currentRoi:null,rois:[],selectionSet:new Set,editingRoiId:null,nextRoiId:1,nextCalibrationOrder:1,analyticalWhiteRoiId:null,metricsCalculated:!1,isAnalysisStale:!1,lastRegressions:[],regressionViewMode:"best",visibleRegressionParameters:new Set,regressionDisplayLimit:15,calibrationChart:null,currentConcentrationUnit:"mg/L",concentrationQueue:[],activeConcentrationModalRoiId:null,deferredInstallPrompt:null,analysisTitle:"",currentTab:"roi-data",appMode:"idle",gridCornerPoints:[],draggedCornerIndex:-1,currentMousePos:{x:0,y:0,dX:0,dY:0},lastGridDims:{rows:3,cols:5},showMagnifier:!1,sequencedRois:[],isFocusMode:!1,isMultiSelectMode:!1,isMagnifierEnabled:!1,isViewLocked:!1,isQualityPanelExpanded:!1,contextMenu:{visible:!1,roiId:null,x:0,y:0},forceViewRecalculationOnFocusModeToggle:!1};const b=()=>d.rois,Z=()=>d.viewTransform,gt=()=>d.currentTool,$=()=>d.selectionSet,Ce=()=>d.editingRoiId,er=()=>d.isDrawing,wi=()=>d.isPanning,tr=()=>d.drawingStartPos,mi=()=>d.lastPanPosition,mt=()=>d.currentRoi,ki=()=>d.isDraggingRoi,Ai=()=>d.isResizingRoi,nr=()=>d.resizeHandle,or=()=>d.dragInitialState,Fo=()=>d.nextRoiId++,ge=()=>d.offscreenCanvas,w=()=>d.analyticalWhiteRoiId,tn=()=>!!d.originalImage.src,$i=()=>d.originalImage,zo=()=>d.metricsCalculated,D=()=>d.lastRegressions,ha=()=>d.regressionViewMode,Pi=()=>d.visibleRegressionParameters,Ti=()=>d.regressionDisplayLimit,Ge=()=>d.calibrationChart,Q=()=>d.currentConcentrationUnit,ar=()=>d.concentrationQueue,ir=()=>d.deferredInstallPrompt,Di=()=>d.isAnalysisStale,We=()=>d.analysisTitle,sr=()=>d.currentTab,z=()=>d.appMode,Ho=()=>d.gridCornerPoints,ya=()=>d.draggedCornerIndex,Oi=()=>d.currentMousePos,va=()=>d.lastGridDims,fi=()=>d.showMagnifier,nn=()=>d.sequencedRois,ba=()=>d.isFocusMode,J=()=>d.isMultiSelectMode,Yt=()=>d.isMagnifierEnabled,on=()=>d.isViewLocked,Ni=()=>d.isQualityPanelExpanded,j=()=>d.contextMenu,rr=()=>d.forceViewRecalculationOnFocusModeToggle,bn=e=>{log("state","data",`Atualizando estado das ROIs. ${e.length} ROIs recebidas.`),d.rois=e},wt=e=>{Object.assign(d.viewTransform,e)},lr=e=>{d.currentTool=e},Ie=()=>{d.selectionSet.clear(),d.editingRoiId=null},Ke=e=>{d.selectionSet.add(e)},cr=e=>{d.selectionSet.delete(e),d.editingRoiId===e&&(d.editingRoiId=null)},qi=e=>{d.selectionSet.has(e)?(d.selectionSet.delete(e),d.editingRoiId===e&&(d.editingRoiId=null)):d.selectionSet.add(e)},xn=e=>{d.editingRoiId=e},da=(e,t,o)=>{d.isDrawing=e,d.drawingStartPos=t,d.currentRoi=o},yn=(e,t)=>{d.isPanning=e,t&&(d.lastPanPosition=t)},dr=e=>{d.dragInitialState=e},ur=e=>{d.isDraggingRoi=e},gr=(e,t,o)=>{d.isResizingRoi=e,d.resizeHandle=t,d.drawingStartPos=o},Ye=e=>{d.analyticalWhiteRoiId=e},xa=e=>{d.offscreenCanvas=e},Fi=e=>{d.originalImage=e},zi=e=>{d.metricsCalculated=e},_o=e=>{d.lastRegressions=e},mr=e=>{d.regressionViewMode=e},fr=e=>{d.visibleRegressionParameters=e},pr=e=>{d.visibleRegressionParameters.has(e)?(d.visibleRegressionParameters.delete(e),log("state","data",`Parâmetro '${e}' removido da visualização.`)):(d.visibleRegressionParameters.add(e),log("state","data",`Parâmetro '${e}' adicionado à visualização.`))},hr=e=>{const t=parseInt(e,10);d.regressionDisplayLimit=!isNaN(t)&&t>0?t:1/0,log("state","data",`Limite de exibição de regressão alterado para: ${d.regressionDisplayLimit}`)},Hi=e=>{d.calibrationChart=e},_i=e=>{d.currentConcentrationUnit=e},Ia=e=>{d.concentrationQueue=e},pi=e=>{d.activeConcentrationModalRoiId=e},Ea=e=>{d.deferredInstallPrompt=e},Vi=e=>{d.isAnalysisStale=e},Gi=e=>{d.analysisTitle=e},yr=e=>{d.currentTab=e},Sa=e=>{d.appMode=e},Ra=e=>{d.isMultiSelectMode=e},vr=e=>{d.gridCornerPoints.length<4&&d.gridCornerPoints.push(e)},br=(e,t)=>{d.gridCornerPoints[e]&&(d.gridCornerPoints[e]=t)},Wi=()=>{d.gridCornerPoints=[]},Yi=e=>{d.draggedCornerIndex=e},ua=e=>{d.currentMousePos=e},xr=e=>{d.lastGridDims=e},Ui=e=>{d.showMagnifier=e},Ir=()=>{d.isFocusMode=!d.isFocusMode,d.forceViewRecalculationOnFocusModeToggle=!0},Xi=()=>{d.isMagnifierEnabled=!d.isMagnifierEnabled},Er=()=>{d.isViewLocked=!d.isViewLocked},Sr=()=>{d.isQualityPanelExpanded=!d.isQualityPanelExpanded,log("state","data",`Estado do painel de qualidade alterado para: ${d.isQualityPanelExpanded?"expandido":"recolhido"}`)},Rr=e=>{d.forceViewRecalculationOnFocusModeToggle=e},Cr=(e,t,o)=>{d.contextMenu={visible:!0,roiId:e,x:t,y:o}},tt=()=>{d.contextMenu&&(d.contextMenu.visible=!1)};function Mr(){if(d.sequencedRois.length===0){ga();return}const e=new Set(d.sequencedRois),t=d.sequencedRois.map(n=>d.rois.find(a=>a.id===n)),o=d.rois.filter(n=>!e.has(n.id));d.rois=[...t,...o],ga()}function Br(){d.appMode="sequencingRois",d.sequencedRois=[]}function Lr(e){d.sequencedRois.includes(e)||d.sequencedRois.push(e)}function wr(){d.sequencedRois.pop()}function ga(){d.appMode="idle",d.sequencedRois=[]}function ji(){d.rois.length=0,d.selectionSet.clear(),d.editingRoiId=null,d.analyticalWhiteRoiId=null,d.nextRoiId=1,d.nextCalibrationOrder=1}function kr(){d.viewTransform={scale:1,offsetX:0,offsetY:0,initialSetupDone:!1}}function Ca(){d.isDrawing=!1,d.isPanning=!1,d.isResizingRoi=!1,d.currentRoi=null,d.draggedCornerIndex=-1,d.showMagnifier=!1,d.activeConcentrationModalRoiId=null,d.dragInitialState=null,d.isDraggingRoi=!1,d.contextMenu&&(d.contextMenu.visible=!1)}function Qi(){ji(),kr(),Ca(),d.appMode="idle",d.sequencedRois=[],d.isViewLocked=!1,d.isMultiSelectMode=!1,d.metricsCalculated=!1,d.isAnalysisStale=!1,d.lastRegressions=[],d.regressionViewMode="best",d.visibleRegressionParameters.clear(),d.regressionDisplayLimit=15,d.isQualityPanelExpanded=!1,d.analysisTitle="",d.calibrationChart&&(d.calibrationChart.destroy(),d.calibrationChart=null)}let Ki,Ji,Zi,In,De,ft,pt,ht,ie,se,Re,yt,En,Sn,vt,Ut,Ma,Ba,Xt,jt,Qt,Rn,La,Oe,$e,Cn,Mn,Bn,re,Ln,wn,de,kn,q,K,V,C,Ne,bt,xt,An,Be,qe,Kt,$n,Fe,Jt,Pn,Tn,wa,be,es,ts,U,Dn,ze,nt,On,Nn,qn,It,Fn,ns,Et,St,zn,He,os,as,is,ss,rs,ls,cs,ds,us,gs,ms,fs,Rt,ps,hs,ys,vs,Hn,_n,ot,ka,xe,Vo,Go,Te,Tt,Aa,Vn,Dt,Ot,Gn,Wn,Yn,Un,Xn,jn,at,$a,Qn,bs,Kn,Jn,Nt,Pa,it,Ta,Zn,xs,eo,to,no,oo,ao,qt,Da,Oa,io,Ft,st,F,an,sn,Is,Es,zt,so,Ht,ro,_t,Ss,lo,co,uo,Ue,Na,Zt,go,mo,fo,po,O,qa,Ct,le,ho,Xe,yo,vo,bo,Wo,Yo,Uo,Xo,xo,Io,Mt,Bt,jo,Qo,je,Eo,So,Ro,Fa,za,Ha,_a,ut,Va,Vt,ve,Co,Mo,Rs,Bo,Ga,Cs,Ko,Wa,Ya,Le,me,Lo,Gt,rt,wo,Ua,ko,Xa,Ao,ja,$o,Qa,lt,ct,Pe;function Ms(){Ki=document.querySelector('[data-id-for-focus-mode="mainControlsPanel"]'),Ji=document.getElementById("autoActionsContainer"),Zi=document.getElementById("roiToolsContainer"),In=document.getElementById("imageUpload"),De=document.getElementById("fileNameDisplay"),ft=document.getElementById("deleteImageButton"),pt=document.getElementById("rotateImageButton"),ht=document.getElementById("resetViewButton"),ie=document.getElementById("rectRoiButton"),se=document.getElementById("circleRoiButton"),Re=document.getElementById("pointerButton"),yt=document.getElementById("deleteAllRoisButton"),En=document.getElementById("duplicateSelectedRoiButton"),Sn=document.getElementById("deleteSelectedRoiButton"),vt=document.getElementById("setAnalyticalWhiteButton"),Ut=document.getElementById("setAsSampleButton"),Ma=document.getElementById("bulkResizeSlider"),Ba=document.getElementById("bulkResizeValue"),Xt=document.getElementById("bulkLockPositionButton"),jt=document.getElementById("bulkLockSizeButton"),Qt=document.getElementById("bulkOrderButton"),Rn=document.getElementById("orderRoisInfoButton"),La=document.getElementById("detectionDropdownContainer"),Oe=document.getElementById("detectionMenuButton"),$e=document.getElementById("detectionMenu"),Cn=document.getElementById("startGridAnalysisButton"),Mn=document.getElementById("startAreaDetectionButton"),Bn=document.getElementById("startAdvancedDetectionButton"),re=document.getElementById("gridAdjustmentControls"),Ln=document.getElementById("confirmGridButton"),wn=document.getElementById("cancelGridButton"),de=document.getElementById("detectionInstructionPanel"),kn=document.getElementById("detectionInstructionText"),q=document.getElementById("cancelInstructionButton"),K=document.getElementById("canvasContainer"),V=document.getElementById("imageCanvas"),C=document.getElementById("roiCanvas"),Ne=document.getElementById("focusModeButton"),bt=document.getElementById("magnifierToggleButton"),xt=document.getElementById("viewLockButton"),An=document.getElementById("viewLockIcon"),Be=document.getElementById("magnifier-container"),qe=document.getElementById("magnifier-canvas"),Kt=document.getElementById("roiContextMenu"),$n=document.getElementById("contextMenuSetSample"),Fe=document.getElementById("contextMenuSetWhite"),Jt=document.getElementById("contextMenuLock"),Pn=document.getElementById("contextMenuDelete"),Tn=document.getElementById("colorTabsContainer"),wa=document.querySelectorAll(".tab-pane"),be=document.getElementById("roiCardsContainer"),es=document.getElementById("analyticalResultsCardsContainer"),ts=document.getElementById("calibrationSetupTableBody"),U=document.getElementById("regressionEquationsContainer"),Dn=document.getElementById("concentrationUnitSelect"),ze=document.getElementById("sampleIdentificationContainer"),nt=document.getElementById("sampleResultsContainer"),On=document.getElementById("calibrationChartCanvas"),Nn=document.getElementById("calculateAllMetricsButton"),qn=document.getElementById("generateCalibrationCurveButton"),It=document.getElementById("clearChartButton"),Fn=document.getElementById("clearConcentrationsButton"),ns=document.getElementById("selectAllForCalibration"),Et=document.getElementById("exportPdfButton"),St=document.getElementById("exportXlsxButton"),zn=document.getElementById("defineRoiOrderButton"),rs=document.getElementById("step1Wrapper"),ls=document.getElementById("step2Wrapper"),cs=document.getElementById("step2Content"),ds=document.getElementById("step2Blocker"),us=document.getElementById("step3Wrapper"),gs=document.getElementById("step3Content"),ms=document.getElementById("step3Blocker"),fs=document.getElementById("step4Wrapper"),Rt=document.getElementById("step4Content"),ps=document.getElementById("step4Blocker"),hs=document.getElementById("step5Wrapper"),ys=document.getElementById("step5Content"),vs=document.getElementById("step5Blocker"),Hn=document.getElementById("finalActionsWrapper"),_n=document.getElementById("analysisStaleWarning"),ot=document.getElementById("noRoiMessage"),ka=document.getElementById("roi-tools-panel"),xe=document.getElementById("messageModal"),Vo=document.getElementById("modalMessageText"),Go=document.getElementById("loadingSpinner"),Te=document.getElementById("closeGeneralModalButton"),Tt=document.getElementById("toast-notification"),Aa=document.getElementById("toast-text"),Vn=document.getElementById("toast-close-button"),Dt=document.getElementById("editRoiNameModal"),Ot=document.getElementById("editRoiNameInput"),Gn=document.getElementById("editRoiNameError"),Wn=document.getElementById("saveRoiNameButton"),Yn=document.getElementById("cancelEditRoiNameModalButton"),Un=document.getElementById("closeEditRoiNameModalButton"),Xn=document.getElementById("concentrationModal"),jn=document.getElementById("concentrationForm"),at=document.getElementById("concentrationInput"),$a=document.getElementById("concentrationModalRoiName"),Qn=document.getElementById("concentrationModalError"),bs=document.getElementById("confirmConcentrationButton"),Kn=document.getElementById("cancelConcentrationButton"),Jn=document.getElementById("closeConcentrationModalButton"),Nt=document.getElementById("textInputModal"),Pa=document.getElementById("textInputModalTitle"),it=document.getElementById("textInputModalInput"),Ta=document.getElementById("textInputModalError"),Zn=document.getElementById("textInputForm"),xs=document.getElementById("confirmTextInputModalButton"),eo=document.getElementById("cancelTextInputModalButton"),to=document.getElementById("closeTextInputModalButton"),no=document.getElementById("mainControlsInfoButton"),oo=document.getElementById("toolsInfoButton"),ao=document.getElementById("roiActionsInfoButton"),qt=document.getElementById("confirmationModal"),Da=document.getElementById("confirmationModalTitle"),Oa=document.getElementById("confirmationModalMessage"),io=document.getElementById("closeConfirmationModalButton"),Ft=document.getElementById("cancelConfirmationButton"),st=document.getElementById("confirmConfirmationButton"),zt=document.getElementById("gridDimensionsModal"),so=document.getElementById("gridDimensionsForm"),Ht=document.getElementById("gridRowsInput"),ro=document.getElementById("gridColsInput"),_t=document.getElementById("gridDimensionsError"),Ss=document.getElementById("confirmGridDimensionsButton"),lo=document.getElementById("cancelGridDimensionsButton"),co=document.getElementById("closeGridDimensionsModalButton"),uo=document.getElementById("openSignalSelectorModalButton"),Ue=document.getElementById("signalSelectorModal"),Na=document.getElementById("closeSignalSelectorModalButton"),Zt=document.getElementById("signalSearchInput"),go=document.getElementById("selectAllSignalsButton"),mo=document.getElementById("selectAllVisibleSignalsButton"),fo=document.getElementById("unselectAllVisibleSignalsButton"),po=document.getElementById("clearAllSignalSelectionsButton"),O=document.getElementById("signalSelectorContainer"),qa=document.getElementById("confirmSignalSelectionButton"),Ct=document.getElementById("saveSessionButton"),le=document.getElementById("loadSessionButton"),ho=document.getElementById("settingsButton"),Xe=document.getElementById("settingsModal"),yo=document.getElementById("closeSettingsModalButton"),vo=document.getElementById("cancelSettingsButton"),bo=document.getElementById("saveSettingsButton"),Wo=document.getElementById("analystNameInput"),Yo=document.getElementById("operatorRoleInput"),Uo=document.getElementById("labNameInput"),Xo=document.getElementById("institutionNameInput"),xo=document.getElementById("labLogoUpload"),Io=document.getElementById("institutionLogoUpload"),Mt=document.getElementById("labLogoPreview"),Bt=document.getElementById("institutionLogoPreview"),jo=document.getElementById("contactEmailInput"),Qo=document.getElementById("contactPhoneInput"),je=document.getElementById("reportDetailsModal"),Eo=document.getElementById("closeReportDetailsModalButton"),So=document.getElementById("cancelReportDetailsButton"),Ro=document.getElementById("confirmAndGeneratePdfButton"),Fa=document.getElementById("sampleIdInput"),za=document.getElementById("reportIdInput"),Ha=document.getElementById("analysisLocationInput"),_a=document.getElementById("applicationAreaInput"),ut=document.getElementById("reportDetailsError"),Va=document.getElementById("includeImageInReport"),Vt=document.getElementById("advancedSequenceModal"),ve=document.getElementById("advancedSequenceForm"),Co=document.getElementById("closeAdvancedSequenceModalButton"),Mo=document.getElementById("cancelAdvancedSequenceButton"),Rs=document.getElementById("confirmAdvancedSequenceButton"),Bo=document.getElementById("advancedSequenceByTouch"),Ga=document.getElementById("sequencePatternHorizontal"),Cs=document.getElementById("sequencePatternVertical"),Ko=document.getElementById("sequenceSerpentineToggle"),Wa=document.getElementById("scanDirectionContainer"),Ya=document.getElementById("readDirectionContainer"),Le=document.getElementById("pwaInstallInfo"),me=document.getElementById("installPwaButton"),Lo=document.getElementById("currentYear"),Gt=document.getElementById("analysisTitleInput"),rt=document.getElementById("autoRoiSettingsModal"),wo=document.getElementById("saturationSlider"),Ua=document.getElementById("saturationValue"),ko=document.getElementById("brightnessSlider"),Xa=document.getElementById("brightnessValue"),Ao=document.getElementById("minAreaSlider"),ja=document.getElementById("minAreaValue"),$o=document.getElementById("circularitySlider"),Qa=document.getElementById("circularityValue"),lt=document.getElementById("cancelAutoRoiSettings"),ct=document.getElementById("runDetectionWithSettings"),F=document.getElementById("metricInfoModal"),an=document.getElementById("closeMetricInfoModalButton"),sn=document.getElementById("metricInfoModalTitle"),Is=document.getElementById("metricInfoFormula"),Es=document.getElementById("metricInfoDescription"),He=document.getElementById("regressionViewModeContainer"),os=document.getElementById("viewModeBest"),as=document.getElementById("viewModeLinear"),is=document.getElementById("viewModePoly"),ss=document.getElementById("viewModeBoth"),Pe=document.getElementById("focus-mode-toolbar"),log("domElements","info","Referências do DOM foram inicializadas com sucesso.")}const aa=Object.freeze(Object.defineProperty({__proto__:null,get advancedSequenceByTouch(){return Bo},get advancedSequenceForm(){return ve},get advancedSequenceModal(){return Vt},get analysisLocationInput(){return Ha},get analysisStaleWarning(){return _n},get analysisTitleInput(){return Gt},get analystNameInput(){return Wo},get analyticalResultsCardsContainer(){return es},get applicationAreaInput(){return _a},get autoActionsContainer(){return Ji},get autoRoiSettingsModal(){return rt},get brightnessSlider(){return ko},get brightnessValue(){return Xa},get bulkLockPositionButton(){return Xt},get bulkLockSizeButton(){return jt},get bulkOrderButton(){return Qt},get bulkResizeSlider(){return Ma},get bulkResizeValue(){return Ba},get calculateAllMetricsButton(){return Nn},get calibrationChartCanvas(){return On},get calibrationSetupTableBody(){return ts},get cancelAdvancedSequenceButton(){return Mo},get cancelAutoRoiSettings(){return lt},get cancelConcentrationButton(){return Kn},get cancelConfirmationButton(){return Ft},get cancelEditRoiNameModalButton(){return Yn},get cancelGridButton(){return wn},get cancelGridDimensionsButton(){return lo},get cancelInstructionButton(){return q},get cancelReportDetailsButton(){return So},get cancelSettingsButton(){return vo},get cancelTextInputModalButton(){return eo},get canvasContainer(){return K},get circleRoiButton(){return se},get circularitySlider(){return $o},get circularityValue(){return Qa},get clearAllSignalSelectionsButton(){return po},get clearChartButton(){return It},get clearConcentrationsButton(){return Fn},get closeAdvancedSequenceModalButton(){return Co},get closeConcentrationModalButton(){return Jn},get closeConfirmationModalButton(){return io},get closeEditRoiNameModalButton(){return Un},get closeGeneralModalButton(){return Te},get closeGridDimensionsModalButton(){return co},get closeMetricInfoModalButton(){return an},get closeReportDetailsModalButton(){return Eo},get closeSettingsModalButton(){return yo},get closeSignalSelectorModalButton(){return Na},get closeTextInputModalButton(){return to},get colorTabsContainer(){return Tn},get concentrationForm(){return jn},get concentrationInput(){return at},get concentrationModal(){return Xn},get concentrationModalError(){return Qn},get concentrationModalRoiName(){return $a},get concentrationUnitSelect(){return Dn},get confirmAdvancedSequenceButton(){return Rs},get confirmAndGeneratePdfButton(){return Ro},get confirmConcentrationButton(){return bs},get confirmConfirmationButton(){return st},get confirmGridButton(){return Ln},get confirmGridDimensionsButton(){return Ss},get confirmSignalSelectionButton(){return qa},get confirmTextInputModalButton(){return xs},get confirmationModal(){return qt},get confirmationModalMessage(){return Oa},get confirmationModalTitle(){return Da},get contactEmailInput(){return jo},get contactPhoneInput(){return Qo},get contextMenuDelete(){return Pn},get contextMenuLock(){return Jt},get contextMenuSetSample(){return $n},get contextMenuSetWhite(){return Fe},get currentYear(){return Lo},get defineRoiOrderButton(){return zn},get deleteAllRoisButton(){return yt},get deleteImageButton(){return ft},get deleteSelectedRoiButton(){return Sn},get detectionDropdownContainer(){return La},get detectionInstructionPanel(){return de},get detectionInstructionText(){return kn},get detectionMenu(){return $e},get detectionMenuButton(){return Oe},get duplicateSelectedRoiButton(){return En},get dynamicActionsPanel(){return ka},get editRoiNameError(){return Gn},get editRoiNameInput(){return Ot},get editRoiNameModal(){return Dt},get exportPdfButton(){return Et},get exportXlsxButton(){return St},get fileNameDisplay(){return De},get finalActionsWrapper(){return Hn},get focusModeButton(){return Ne},get focusModeToolbar(){return Pe},get generateCalibrationCurveButton(){return qn},get gridAdjustmentControls(){return re},get gridColsInput(){return ro},get gridDimensionsError(){return _t},get gridDimensionsForm(){return so},get gridDimensionsModal(){return zt},get gridRowsInput(){return Ht},get imageCanvas(){return V},get imageUpload(){return In},get includeImageInReportCheckbox(){return Va},initializeDomElements:Ms,get installPwaButton(){return me},get institutionLogoPreview(){return Bt},get institutionLogoUpload(){return Io},get institutionNameInput(){return Xo},get labLogoPreview(){return Mt},get labLogoUpload(){return xo},get labNameInput(){return Uo},get loadSessionButton(){return le},get loadingSpinner(){return Go},get magnifierCanvas(){return qe},get magnifierContainer(){return Be},get magnifierToggleButton(){return bt},get mainControlsInfoButton(){return no},get mainControlsPanel(){return Ki},get messageModal(){return xe},get metricInfoDescription(){return Es},get metricInfoFormula(){return Is},get metricInfoModal(){return F},get metricInfoModalTitle(){return sn},get minAreaSlider(){return Ao},get minAreaValue(){return ja},get modalMessageText(){return Vo},get noRoiMessage(){return ot},get openSignalSelectorModalButton(){return uo},get operatorRoleInput(){return Yo},get orderRoisInfoButton(){return Rn},get pointerButton(){return Re},get pwaInstallInfo(){return Le},get readDirectionContainer(){return Ya},get rectRoiButton(){return ie},get regressionEquationsContainer(){return U},get regressionViewModeContainer(){return He},get reportDetailsError(){return ut},get reportDetailsModal(){return je},get reportIdInput(){return za},get resetViewButton(){return ht},get roiActionsInfoButton(){return ao},get roiCanvas(){return C},get roiCardsContainer(){return be},get roiContextMenu(){return Kt},get roiToolsContainer(){return Zi},get rotateImageButton(){return pt},get runDetectionWithSettings(){return ct},get sampleIdInput(){return Fa},get sampleIdentificationContainer(){return ze},get sampleResultsContainer(){return nt},get saturationSlider(){return wo},get saturationValue(){return Ua},get saveRoiNameButton(){return Wn},get saveSessionButton(){return Ct},get saveSettingsButton(){return bo},get scanDirectionContainer(){return Wa},get selectAllForCalibration(){return ns},get selectAllSignalsButton(){return go},get selectAllVisibleSignalsButton(){return mo},get sequencePatternHorizontal(){return Ga},get sequencePatternVertical(){return Cs},get sequenceSerpentineToggle(){return Ko},get setAnalyticalWhiteButton(){return vt},get setAsSampleButton(){return Ut},get settingsButton(){return ho},get settingsModal(){return Xe},get signalSearchInput(){return Zt},get signalSelectorContainer(){return O},get signalSelectorModal(){return Ue},get startAdvancedDetectionButton(){return Bn},get startAreaDetectionButton(){return Mn},get startGridAnalysisButton(){return Cn},get step1Wrapper(){return rs},get step2Blocker(){return ds},get step2Content(){return cs},get step2Wrapper(){return ls},get step3Blocker(){return ms},get step3Content(){return gs},get step3Wrapper(){return us},get step4Blocker(){return ps},get step4Content(){return Rt},get step4Wrapper(){return fs},get step5Blocker(){return vs},get step5Content(){return ys},get step5Wrapper(){return hs},get tabPanes(){return wa},get textInputForm(){return Zn},get textInputModal(){return Nt},get textInputModalError(){return Ta},get textInputModalInput(){return it},get textInputModalTitle(){return Pa},get toastCloseButton(){return Vn},get toastNotification(){return Tt},get toastText(){return Aa},get toolsInfoButton(){return oo},get unselectAllVisibleSignalsButton(){return fo},get viewLockButton(){return xt},get viewLockIcon(){return An},get viewModeBest(){return os},get viewModeBoth(){return ss},get viewModeLinear(){return as},get viewModePoly(){return is}},Symbol.toStringTag,{value:"Module"})),hi=Object.values(analyticalEquationsBySystem).flatMap(e=>Object.values(e).flat());function en(e){let t=hi.find(n=>`SA (${n.systemName||Object.keys(analyticalEquationsBySystem).find(a=>analyticalEquationsBySystem[a]===Object.values(analyticalEquationsBySystem).find(i=>Object.values(i).flat().includes(n)))} - ${n.text})`===e);if(t)return t;const o=e.replace("SA (","").replace(")","");return hi.find(n=>o.endsWith(n.text))}function Ar(){if(!be)return;log("domRenderer","perf","Executando atualização otimizada de seleção de cards.");const e=$(),t=Ce();for(const o of be.children)if(o.classList.contains("roi-card")){const n=parseInt(o.dataset.roiId,10);isNaN(n)||(o.classList.toggle("multi-selected",e.has(n)),o.classList.toggle("editing-roi",n===t))}}function $r(){if(!be)return;be.innerHTML="";const e=(s,r=3)=>s!=null&&!isNaN(parseFloat(s))?parseFloat(s).toFixed(r):"N/D",t=b(),o=w(),n=$(),a=Ce();if(t.length===0){ot&&(ot.style.display="block");return}ot&&(ot.style.display="none");const i=t.filter(s=>s.isSample).sort((s,r)=>s.id-r.id);t.forEach(s=>{const r=n.has(s.id),l=s.id===a,u=document.createElement("div"),g=s.isSample?"sample-bg":s.id===o?"analytical-white-bg":"";u.className=`roi-card ${g} ${r?"multi-selected":""} ${l?"editing-roi":""}`,u.dataset.roiId=s.id;const c=document.createElement("div");c.className=`roi-card-header ${s.isDetailsExpanded?"expanded":""}`;let m="",f=s.customName||s.name;if(s.id===o)m="⭐ ",f=s.customName||"BRANCO";else if(s.isSample){const Se=i.findIndex(X=>X.id===s.id);m="🧪 ",f=s.customName||`Amostra ${Se+1}`}const p=s.isPositionLocked&&s.isSizeLocked?" 🔒":s.isPositionLocked?" 🔒(P)":s.isSizeLocked?" 🔒(T)":"";let y=`<span class="font-semibold text-sm truncate" style="max-width:120px" title="${f}">${m}${f}${p}</span>`;!s.isSample&&s.id!==o&&(y+='<button class="edit-name-button-class ml-1 p-0.5 text-blue-500 hover:text-blue-700" title="Editar Nome"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-pencil-fill inline-block" viewBox="0 0 16 16"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-2a.5.5 0 0 0 0 1h1.5v1.5h1.5v1.5h1.5v1.5A1.5 1.5 0 0 0 6.5 15h6a1.5 1.5 0 0 0 1.5-1.5V10h-2v2.707l-4.146 4.147A.5.5 0 0 1 6.032 13.85z"/></svg></button>'),c.innerHTML=`<div class="flex items-center">${y}</div><button class="expand-details-button text-lg leading-none p-1">${s.isDetailsExpanded?"▼":"▶"}</button>`;const h=document.createElement("div");h.className="roi-card-body";const x=s.rgb?e(s.rgb.avgR):"...",E=s.rgb?e(s.rgb.avgG):"...",I=s.rgb?e(s.rgb.avgB):"...",M=s.rgb?e(s.rgb.avgRGB):"...";h.innerHTML=`<div class="grid grid-cols-2 sm:grid-cols-4 gap-x-3 gap-y-1 text-sm"><div><strong class="text-red-600">R:</strong> ${x}</div><div><strong class="text-green-600">G:</strong> ${E}</div><div><strong class="text-blue-600">B:</strong> ${I}</div><div><strong>Média RGB:</strong> ${M}</div></div>`;const S=document.createElement("div");S.className=`roi-card-details ${s.isDetailsExpanded?"":"hidden"}`;const B=s.rgb_stdDev?e(s.rgb_stdDev.r):"...",P=s.rgb_stdDev?e(s.rgb_stdDev.g):"...",L=s.rgb_stdDev?e(s.rgb_stdDev.b):"...",_=s.hsv&&s.hsv.h!==void 0?`${e(s.hsv.h,0)}, ${e(s.hsv.s,1)}%, ${e(s.hsv.v,1)}%`:"Calculando...",Ee=s.hsl&&s.hsl.h!==void 0?`${e(s.hsl.h,0)}, ${e(s.hsl.s,1)}%, ${e(s.hsl.l,1)}%`:"Calculando...",pe=s.lab&&s.lab.l!==void 0?`L*${e(s.lab.l,1)}, a*${e(s.lab.a,1)}, b*${e(s.lab.b,1)}`:"Calculando...",te=s.ycbcr&&s.ycbcr.y!==void 0?`Y:${e(s.ycbcr.y,1)}, Cb:${e(s.ycbcr.cb,1)}, Cr:${e(s.ycbcr.cr,1)}`:"Calculando...",ne=s.cmyk&&s.cmyk.c!==void 0?`C:${e(s.cmyk.c,1)}%, M:${e(s.cmyk.m,1)}%, Y:${e(s.cmyk.y,1)}%, K:${e(s.cmyk.k,1)}%`:"Calculando...",et=s.xyz&&s.xyz.x!==void 0?`X:${e(s.xyz.x,1)}, Y:${e(s.xyz.y,1)}, Z:${e(s.xyz.z,1)}`:"Calculando...",dn=s.hunterLab&&s.hunterLab.l!==void 0?`L:${e(s.hunterLab.l,1)}, a:${e(s.hunterLab.a,1)}, b:${e(s.hunterLab.b,1)}`:"Calculando...";let At=`<div class="details-grid grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-1 text-xs p-2">
            <div><strong>DP R:</strong> ${B}</div>
            <div><strong>DP G:</strong> ${P}</div>
            <div><strong>DP B:</strong> ${L}</div>
            <div><strong>Pixels:</strong> ${s.pixelCount||"..."}</div>
            <div><strong>Formato:</strong> ${s.type==="rect"?"Retangular":"Circular"}</div>
            <div><strong>Coords:</strong> (${s.x.toFixed(0)},${s.y.toFixed(0)})</div>
            <div><strong>Tam/Diâm:</strong> ${s.type==="rect"?`${s.width.toFixed(0)}x${s.height.toFixed(0)}`:`Ø${(s.radius*2).toFixed(0)}`}</div>
            <div><strong>HSV:</strong> ${_}</div>
            <div><strong>HSL:</strong> ${Ee}</div>
            <div><strong>CIELAB:</strong> ${pe}</div>
            <div><strong>YCbCr:</strong> ${te}</div>
            <div><strong>CMYK:</strong> ${ne}</div>
            <div><strong>HunterLab:</strong> ${dn}</div>
            <div><strong>CIE XYZ:</strong> ${et}</div>
        </div>`;if(s.analyticalResponse&&s.analyticalResponse.length>0){let Se='<div class="border-t mt-2 pt-2 text-xs"><h4 class="font-semibold text-gray-700 mb-1">Métricas Analíticas (SA)</h4><div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4">';s.analyticalResponse.sort((X,he)=>X.channel.localeCompare(he.channel)).forEach(X=>{const he=en(X.channel),un=he?he.fullName:X.channel,gn=he?`Fórmula: ${he.formula}`:X.channel;Se+=`<div><strong title="${gn}">${un}:</strong> ${e(X.value,4)}</div>`}),Se+="</div></div>",At+=Se}S.innerHTML=At,u.appendChild(c),u.appendChild(h),u.appendChild(S),be.appendChild(u)})}function Ka(){const e=O;if(!e)return;const t=Array.from(e.querySelectorAll("input:checked")).map(a=>a.value);if(e.innerHTML="",!b().some(a=>a.analyticalResponse&&a.analyticalResponse.length>0)){e.innerHTML='<p class="text-xs text-gray-500 p-4 text-center">Calcule todas as métricas no Passo 1 para ver os parâmetros disponíveis.</p>';return}const n=["RGB","CIELAB","HSV","HSL","YCbCr","CMYK","HunterLab","XYZ","Sintéticos (Inter-sistema)"];for(const a of n){if(!analyticalEquationsBySystem[a])continue;const i=document.createElement("div");i.className="accordion-item",i.dataset.systemName=a;const s=document.createElement("div");s.className="accordion-header flex items-center cursor-pointer p-2 bg-gray-100 hover:bg-gray-200 rounded-md",s.innerHTML=`<span class="accordion-icon font-bold text-lg mr-2 transition-transform">▶</span><h5 class="font-semibold text-gray-800 text-sm">${a}</h5>`;const r=document.createElement("div");r.className="accordion-body hidden pl-4 pt-1 border-l-2 ml-3";const l=analyticalEquationsBySystem[a];for(const u in l){const g=document.createElement("div");g.className="accordion-item mt-1",g.dataset.groupName=u;const c=document.createElement("div");c.className="accordion-header flex items-center cursor-pointer py-1",c.innerHTML=`<span class="accordion-icon font-bold text-md mr-2 transition-transform">▶</span><h6 class="text-xs font-semibold text-gray-600">${u}</h6>`;const m=document.createElement("div");m.className="accordion-body hidden pl-5",l[u].forEach(p=>{const y=`SA (${a} - ${p.text})`,h=document.createElement("div");h.className="flex items-center my-1";const x=t.includes(y),E=p.fullName||p.text;h.innerHTML=`
                    <input type="checkbox" id="y-axis-${y}" name="y-axis-param" value="${y}" class="form-checkbox h-3.5 w-3.5">
                    <label for="y-axis-${y}" class="text-sm cursor-pointer ml-2 flex items-center justify-between w-full">
                        <span class="flex-grow">${E}</span>
                        <span class="metric-info-icon" data-metric-id="${p.id}" title="Ver detalhes da métrica">i</span>
                    </label>
                `,h.querySelector("input").checked=x,m.appendChild(h)}),g.appendChild(c),g.appendChild(m),r.appendChild(g)}i.appendChild(s),i.appendChild(r),e.appendChild(i)}}function Pr(e,t){const o=O;if(!o)return;log("domRenderer","info",`Renderizando ${e.length} resultados de busca para o termo: "${t}".`);const n=new Set(Array.from(o.querySelectorAll("input:checked")).map(a=>a.value));if(e.forEach(a=>{a.isChecked&&n.add(a.channelName)}),o.innerHTML="",e.length===0){o.innerHTML=`<p class="text-sm text-gray-500 p-4 text-center">Nenhum resultado encontrado para "<strong>${t}</strong>".</p>`;return}e.forEach(a=>{const i=document.createElement("div");i.className="flex items-center my-1 p-2 hover:bg-gray-50 rounded-md";const s=n.has(a.channelName),r=a.equation.fullName||a.equation.text;i.innerHTML=`
            <input type="checkbox" id="y-axis-${a.channelName}" name="y-axis-param" value="${a.channelName}" class="form-checkbox h-3.5 w-3.5">
            <label for="y-axis-${a.channelName}" class="text-sm cursor-pointer ml-3 flex-grow flex items-center justify-between">
                <span class="flex-grow">
                    ${r}
                    <span class="text-xs text-gray-400 ml-2">(${a.systemName} &gt; ${a.groupName})</span>
                </span>
                <span class="metric-info-icon" data-metric-id="${a.equation.id}" title="Ver detalhes da métrica">i</span>
            </label>
        `,i.querySelector("input").checked=s,o.appendChild(i)})}function Ja(){const e=document.getElementById("calibrationSetupTable");if(!e){log("domRenderer","warn","Elemento da tabela de calibração não encontrado no DOM.");return}log("domRenderer","info","Iniciando renderização da tabela de calibração.");const t=b().filter(i=>i.calibrationOrder!==null&&i.calibrationOrder!==void 0);t.sort((i,s)=>i.calibrationOrder-s.calibrationOrder),log("domRenderer","data",`Renderizando ${t.length} ROIs na tabela de calibração.`,t.map(i=>`ID: ${i.id} (Ordem: ${i.calibrationOrder})`));const o=`
        <thead class="bg-gray-100 sticky top-0 z-10">
            <tr>
                <th class="p-1 sm:p-2 text-center font-semibold text-gray-600 text-xs w-[10%]" title="Arrastar para reordenar"></th>
                <th class="p-1 sm:p-2 text-center font-semibold text-gray-600 text-xs w-[15%]">Ponto #</th>
                <th class="p-1 sm:p-2 text-left font-semibold text-gray-600 text-xs w-[35%]">Nome ROI</th>
                <th class="p-1 sm:p-2 text-left font-semibold text-gray-600 text-xs w-[25%]">Concentração</th>
                <th id="selectAllHeaderCell" class="p-1 sm:p-2 text-center font-semibold text-gray-600 text-xs w-[15%]">
                    <label for="selectAllForCalibration" class="flex justify-center items-center cursor-pointer unselectable">
                         <span class="hidden sm:inline">Incluir</span>
                         <input type="checkbox" id="selectAllForCalibration" title="Selecionar Todas" class="form-checkbox !ml-1 sm:!ml-2"/>
                    </label>
                </th>
            </tr>
        </thead>
    `;let n;t.length===0?n=`<tbody><tr><td colspan="5" class="text-center text-xs text-gray-500 p-4">Nenhuma ROI de calibração disponível. Defina ROIs como Padrão na aba 'Dados ROI'.</td></tr></tbody>`:n='<tbody id="calibrationSetupTableBody">'+t.map((i,s)=>{const r=i.customName||i.name,l=i.concentration!==null,u=!l,g=i.useInCalibration&&l;return`
                <tr class="border-b calibration-row" data-roi-id="${i.id}" draggable="true">
                    <td class="drag-handle-cell p-1 text-center align-middle" title="Arrastar para reordenar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-grip-vertical inline-block text-gray-400 cursor-grab" viewBox="0 0 16 16"><path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg>
                    </td>
                    <td class="p-1 sm:p-2 text-center align-middle text-sm font-medium text-gray-500">${s+1}</td>
                    <td class="p-1 sm:p-2 text-left align-middle text-sm text-gray-800 truncate" title="${r}">${r}</td>
                    <td class="p-1 sm:p-2 align-middle">
                        <input type="number" step="any" class="form-input w-full text-xs p-1" data-roi-id="${i.id}" placeholder="Ex: 0.5" value="${i.concentration??""}">
                    </td>
                    <td class="p-1 sm:p-2 text-center align-middle flex justify-center items-center">
                        <input type="checkbox" class="form-checkbox calibration-checkbox" data-roi-id="${i.id}" ${g?"checked":""} ${u?"disabled":""}>
                    </td>
                </tr>
            `}).join("")+"</tbody>",e.innerHTML=o+n;const a=document.getElementById("selectAllForCalibration");if(a){const i=t.length>0&&t.every(s=>s.useInCalibration);a.checked=i}}function Bs(){if(!ze)return;const e=b().filter(o=>o.isSample);if(e.length===0){ze.innerHTML='<p class="text-sm text-center text-gray-500 p-4 bg-gray-50 rounded-md">Nenhuma ROI foi definida como amostra.</p>';return}let t='<table class="sample-id-table w-full"><thead><tr><th>Nome Interno</th><th>Descrição da Amostra</th><th>Resultados</th></tr></thead><tbody>';e.forEach(o=>{const n=[...o.predictedConcentrations].sort((m,f)=>f.r2-m.r2),a=n.length>0?n[0]:null,i=a?n.slice(1):[],s={};i.forEach(m=>{s[m.system]||(s[m.system]=[]),s[m.system].push(m)});const r=a?a.r2.toFixed(4):"N/A",l=o.sampleDescription||'<span class="text-gray-400 italic">Clique para adicionar...</span>',u=a?en(a.parameter):null,g=u?u.fullName:a?a.parameter:"",c=u?`Fórmula: ${u.formula}`:"";t+=`
            <tr class="sample-main-row" data-roi-id="${o.id}">
                <td data-label="Nome Interno">${o.customName||`ID: ${o.id}`}</td>
                <td data-label="Descrição"><div class="sample-description-display p-2 border border-dashed border-gray-400 rounded-md cursor-pointer" data-roi-id="${o.id}">${l}</div></td>
                <td data-label="Melhor Resultado">
                    ${a?`<div class="flex justify-between items-center">
                            <div><strong class="text-base">${a.concentration.toFixed(4)}</strong><span class="text-sm text-gray-700 ml-1">${Q()}</span><br><span class="text-xs text-gray-500" title="${c}">(Parâmetro: ${g} | R²=${r})</span></div>
                            <span class="toggle-details-btn p-1 cursor-pointer text-lg" title="Ver todos os resultados">▶</span>
                        </div>`:"Nenhuma previsão disponível."}
                </td>
            </tr>
            <tr class="sample-detail-row hidden"><td colspan="3"><div class="p-3 bg-gray-50">
                <div class="p-2 rounded-md mb-3 best-result-highlight"><h4 class="font-semibold text-sm mb-2 text-gray-800">Melhor Resultado</h4>
                    ${a?`<div class="detail-card text-sm"><strong>Parâmetro:</strong> ${g}<br><strong>Concentração Prevista:</strong> ${a.concentration.toFixed(4)} ${Q()}<br><div class="text-gray-600 mt-1"><strong>Equação:</strong> ${a.equation}</div><div class="text-gray-600"><strong>R²:</strong> ${r}</div></div>`:""}
                </div>
                ${Object.keys(s).length>0?`<hr class="my-3"><h4 class="font-semibold text-sm my-2 text-gray-700">Outros resultados</h4>
                    ${Object.keys(s).map(m=>`<div class="mb-3"><h5 class="font-semibold text-xs mb-1 text-gray-600 p-1 bg-gray-100 rounded-t-md border-b">${m}</h5>
                        ${s[m].map(f=>{const p=en(f.parameter),y=f.r2?f.r2.toFixed(4):"N/A";return`<div class="detail-card text-sm"><strong>Parâmetro:</strong> ${p?p.fullName:f.parameter}<br><strong>Concentração Prevista:</strong> ${f.concentration.toFixed(4)} ${Q()}<br><div class="text-gray-600 mt-1"><strong>Equação:</strong> ${f.equation}</div><div class="text-gray-600"><strong>R²:</strong> ${y}</div></div>`}).join("")}
                    </div>`).join("")}`:'<p class="text-xs text-gray-500 mt-3">Não há outros resultados para exibir.</p>'}
            </div></td></tr>`}),t+="</tbody></table>",ze.innerHTML=t}function Tr(){if(!nt)return;const e=b().filter(a=>a.isSample),t=Q();if(e.length===0){nt.innerHTML='<p class="text-sm text-gray-500 p-4 text-center">Marque uma ou mais ROIs como "Amostra" para ver as previsões aqui.</p>';return}if(D().length===0){nt.innerHTML='<p class="text-sm text-gray-500 p-4 text-center">Gere uma curva analítica para ver as previsões para as amostras.</p>';return}let o="";e.sort((a,i)=>a.id-i.id).forEach((a,i)=>{const s=a.customName||`Amostra ${i+1}`,r=a.sampleDescription?`<p class="text-xs text-gray-500 mt-1">${a.sampleDescription}</p>`:"";let l='<p class="text-xs text-gray-500 p-2">Nenhuma previsão disponível para esta amostra.</p>';a.predictedConcentrations&&a.predictedConcentrations.length>0&&(l=[...a.predictedConcentrations].sort((g,c)=>c.r2-g.r2).map((g,c)=>{const m=g.r2?g.r2.toFixed(4):"N/A",f=en(g.parameter),p=f?f.fullName:g.parameter,y=f?`Fórmula: ${f.formula}`:g.parameter;return`
                    <div class="flex justify-between items-center py-2 px-3 my-1 rounded-md border ${c===0?"bg-green-50 border-green-200":""} last:border-b-0">
                        <div class="text-sm">
                            <span class="font-semibold text-gray-800">${g.concentration.toFixed(4)}</span>
                            <span class="text-xs text-gray-600 ml-1">${t}</span>
                            <p class="text-xs text-gray-500" title="${y}">${p}</p>
                        </div>
                        <div class="text-xs text-right text-gray-500">
                            <span>R² = ${m}</span>
                        </div>
                    </div>
                `}).join("")),o+=`
            <div class="result-card mb-4">
                <div class="result-card-header">
                    <div class="flex-grow">
                        <h4 class="font-semibold text-gray-800">🧪 ${s}</h4>
                        ${r}
                    </div>
                </div>
                <div class="result-card-body">
                    ${l}
                </div>
            </div>
        `}),nt.innerHTML=o}function ke(e,t="—"){return e==null?t:isNaN(e)?"N/D":e===0?"0.0000":Math.abs(e)>1e3||Math.abs(e)<.001&&Math.abs(e)>0?e.toExponential(3):e.toFixed(4)}function Dr(e){let t=document.getElementById("qualityControlPanelContainer");if(!t&&Rt&&(t=document.createElement("div"),t.id="qualityControlPanelContainer",t.className="my-4",U?U.after(t):Rt.appendChild(t)),!t){log("domRenderer","error","Não foi possível encontrar ou criar o container para o painel de QC.");return}if(e.length===0){t.innerHTML="",t.classList.add("hidden");return}const o=Ni(),n=o?"":"hidden",a=o?"rotate-90":"",i=e.map(r=>{const l=en(r.parameter),u=l?l.fullName:r.parameter,g=r.quality||{},c=g.range?`${ke(g.range.min)} - ${ke(g.range.max)}`:"—",m=r.type==="linear"?ke(r.coefficients.m):"—",f=ke(g.Syx),p=ke(g.lod),y=ke(g.loq);return`
            <tr class="border-b hover:bg-gray-50">
                <td class="p-2 text-xs truncate" title="${u}">${u}</td>
                <td class="p-2 text-xs text-center font-semibold">${r.type==="linear"?"Linear":"Polinomial"}</td>
                <td class="p-2 text-xs text-center font-mono">${ke(r.r2)}</td>
                <td class="p-2 text-xs text-center font-mono">${m}</td>
                <td class="p-2 text-xs text-center font-mono">${f}</td>
                <td class="p-2 text-xs text-center font-mono">${p}</td>
                <td class="p-2 text-xs text-center font-mono">${y}</td>
                <td class="p-2 text-xs text-center font-mono">${c}</td>
            </tr>
        `}).join(""),s=`
        <div class="analysis-section accordion-item">
            <div class="accordion-header flex items-center justify-between cursor-pointer p-2 bg-gray-50 hover:bg-gray-100 rounded-t-md border">
                <h4 class="font-semibold text-gray-700 text-sm">Painel de Controle de Qualidade</h4>
                <span class="accordion-icon font-bold text-lg transition-transform ${a}">▶</span>
            </div>
            <div class="accordion-body ${n} border border-t-0 rounded-b-md p-1">
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 text-left text-xs font-semibold text-gray-600 cursor-pointer" data-sort-by="parameter" title="Ordenar por Parâmetro"><span>Parâmetro</span></th>
                                <th class="p-2 text-center text-xs font-semibold text-gray-600"><span>Modelo</span></th>
                                <th class="p-2 text-center text-xs font-semibold text-gray-600 cursor-pointer" data-sort-by="r2" title="Ordenar por Coeficiente de Determinação (R²)"><span>R² ↓</span></th>
                                <th class="p-2 text-center text-xs font-semibold text-gray-600 cursor-pointer" data-sort-by="sensitivity" title="Ordenar por Coeficiente Angular (Sensibilidade)"><span>Sensibilidade</span></th>
                                <th class="p-2 text-center text-xs font-semibold text-gray-600 cursor-pointer" data-sort-by="Syx" title="Ordenar por Erro Padrão da Regressão"><span>S<sub>y/x</sub></span></th>
                                <th class="p-2 text-center text-xs font-semibold text-gray-600 cursor-pointer" data-sort-by="lod" title="Ordenar por Limite de Detecção"><span>LOD</span></th>
                                <th class="p-2 text-center text-xs font-semibold text-gray-600 cursor-pointer" data-sort-by="loq" title="Ordenar por Limite de Quantificação"><span>LOQ</span></th>
                                <th class="p-2 text-center text-xs font-semibold text-gray-600"><span>Faixa de Calibração</span></th>
                                <th class="p-2 text-center text-xs font-semibold text-gray-600">
                                    <button id="quality-panel-info-button" title="Informações sobre as métricas" class="p-1 rounded-full hover:bg-gray-200">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-info-circle-fill text-sky-700" viewBox="0 0 16 16">
                                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zM8 4a.905.905 0 0 1 .9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995A.905.905 0 0 1 8 4zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                                        </svg>
                                    </button>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            ${i}
                        </tbody>
                    </table>
                </div>
                 <p class="text-xs text-gray-500 mt-2 p-2">LOD, LOQ e Sensibilidade são aplicáveis apenas a modelos lineares. Clique nos cabeçalhos para reordenar.</p>
            </div>
        </div>
    `;t.innerHTML=s,t.classList.remove("hidden"),log("domRenderer","success","Painel de Controle de Qualidade renderizado com sucesso.")}const Or=5;function Jo(){if(Ge()&&Ge().destroy(),!On)return;const e=On.getContext("2d"),t=new Chart(e,{type:"scatter",data:{datasets:[]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!!We(),text:We(),font:{size:16}},legend:{display:!1},customCanvasBackgroundColor:{color:"#FFF"}},scales:{x:{type:"linear",position:"bottom",title:{display:!0,text:`Concentração (${Q()})`}},y:{title:{display:!0,text:"Sinal Analítico (SA)"}}}},plugins:[{id:"customCanvasBackgroundColor",beforeDraw:(o,n,a)=>{const{ctx:i}=o;i.save(),i.globalCompositeOperation="destination-over",i.fillStyle=a.color||"#99ffff",i.fillRect(0,0,o.width,o.height),i.restore()}}]});Hi(t),log("chartManager","success","Instância do gráfico criada e salva no estado.")}function Nr(){log("chartManager","info","Iniciando processo para gerar curva de calibração.");const e=ei(),t=b().filter(o=>o.useInCalibration&&o.concentration!==null);if(t.length<3){R("São necessários pelo menos 3 pontos de calibração para gerar os modelos de regressão (Polinomial e Linear).");return}Ze("Calculando modelos de regressão..."),window.dispatchEvent(new CustomEvent("generate-regressions",{detail:{roisForCalibration:t,selectedParams:e}}))}function Po(e,t){log("chartManager","info",`Renderizando gráfico com ${e.length} parâmetros.`);let o=Ge();if(!o&&(log("chartManager","warn","Instância do gráfico não encontrada. Recriando agora..."),Jo(),o=Ge(),!o)){log("chartManager","error","Falha crítica ao reinicializar o gráfico."),R("Ocorreu um erro crítico ao tentar exibir o gráfico.");return}if(!t||t.length===0){log("chartManager","error","Estilos do gráfico não fornecidos ou vazios."),R("Erro de configuração: Estilos do gráfico não foram carregados.");return}_o(e),o.data.datasets=[];const n=ha(),a=Ti();let i=[...e];i.sort((m,f)=>{const p=Math.max(...m.models.map(h=>h.r2));return Math.max(...f.models.map(h=>h.r2))-p});const s=n==="best"?Or:a;i.length>s&&(i=i.slice(0,s));const r=Pi(),l=i.filter(m=>r.has(m.parameter));log("chartManager","data",`Total de regressões a serem exibidas no gráfico: ${l.length}`);const u=b().filter(m=>m.useInCalibration&&m.concentration!==null),g=[];l.forEach(m=>{const f=D().findIndex(E=>E.parameter===m.parameter),p=t[f%t.length],y=u.map(E=>{const I=E.analyticalResponse.find(M=>M.channel===m.parameter);return I?{x:E.concentration,y:I.value}:null}).filter(Boolean);g.push({label:m.parameter,data:y,backgroundColor:p.backgroundColor,borderColor:p.borderColor,pointStyle:p.pointStyle,type:"scatter",order:0});const h=m.models.find(E=>E.type==="linear"),x=m.models.find(E=>E.type==="polynomial");switch(n){case"best":const E=[h,x].filter(Boolean).reduce((I,M)=>M.r2>I.r2?M:I,{r2:-1/0});E.type&&g.push($t(E,y,p.borderColor,"solid"));break;case"linear":h&&g.push($t(h,y,p.borderColor,"solid"));break;case"polynomial":x&&g.push($t(x,y,p.borderColor,"dotted"));break;case"comparative":h&&g.push($t(h,y,p.borderColor,"solid")),x&&g.push($t(x,y,p.borderColor,"dotted"));break}}),o.data.datasets=g,o.options.scales.x.title.text=`Concentração (${Q()})`,o.options.plugins.title.text=We(),o.options.plugins.title.display=!!We(),o.update(),Fr(i,t);const c=i.flatMap(m=>{const f=m.models.find(x=>x.type==="linear"),p=m.models.find(x=>x.type==="polynomial"),y=[f,p].filter(Boolean).reduce((x,E)=>E.r2>x.r2?E:x,{r2:-1/0});let h=[];switch(n){case"linear":f&&h.push(f);break;case"polynomial":p&&h.push(p);break;case"best":y.type&&h.push(y);break;case"comparative":f&&h.push(f),p&&h.push(p);break}return h.map(x=>({...x,parameter:m.parameter}))});log("chartManager","data",`Enviando ${c.length} modelos filtrados para o Painel de Controle de Qualidade.`),Dr(c)}function qr(e){if(!e)return null;for(const t of Object.values(analyticalEquationsBySystem))for(const o of Object.values(t)){const n=o.find(a=>e.endsWith(`- ${a.text})`));if(n)return n}return null}function Fr(e,t){const o=U;if(!o)return;if(o.innerHTML="",e.length===0){o.classList.add("hidden");return}const n=D().length,a=ha();let i="";if(a!=="best"){const u=Ti(),g=isFinite(u)?u:"";i=`
            <div class="p-2 mb-2 text-xs text-center bg-slate-100 text-slate-700 rounded-md flex items-center justify-center flex-wrap gap-2">
                <span>${isFinite(u)?`Exibindo <b>${e.length}</b> de <b>${n}</b> melhores modelos.`:`Exibindo todos os <b>${n}</b> modelos.`}</span>
                <input type="number" id="regression-limit-input" value="${g}" placeholder="Todos" class="form-input w-20 text-xs p-1 mx-1">
                <button id="apply-regression-limit" class="px-2 py-1 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-xs">Aplicar</button>
                <div class="hidden sm:inline-block border-l h-4 border-slate-300 mx-1"></div>
                <span class="font-semibold hidden sm:inline">Atalhos:</span>
                <button class="limit-shortcut-btn" data-limit="5">5</button>
                <button class="limit-shortcut-btn" data-limit="10">10</button>
                <button class="limit-shortcut-btn" data-limit="25">25</button>
                <button class="limit-shortcut-btn" data-limit="Infinity">Todos</button>
            </div>
        `}let s="";const r=Pi(),l=a==="comparative"||a==="best"&&e.length>0;e.forEach(u=>{const g=D().findIndex(I=>I.parameter===u.parameter),c=t[g%t.length],m=u.models.find(I=>I.type==="linear"),f=u.models.find(I=>I.type==="polynomial"),p=[m,f].filter(Boolean).reduce((I,M)=>M.r2>I.r2?M:I,{r2:-1/0}),y=r.has(u.parameter)?"checked":"",h=`<input type="checkbox" class="regression-visibility-toggle form-checkbox h-4 w-4 mr-3 cursor-pointer" data-param-name="${u.parameter}" ${y}>`,x=qr(u.parameter),E=x?x.fullName:u.parameter;if(l)s+=`<div class="regression-group p-2 my-1 border rounded-md flex items-start" style="border-left-color: ${c.borderColor}; border-left-width: 4px;">
                ${h}
                <div>
                    <strong class="text-sm flex items-center">${E}</strong>`,m&&(s+=`<div class="text-xs ml-1 mt-1">${ia(m)} ${m===p?"⭐":""}</div>`),f&&(s+=`<div class="text-xs ml-1 mt-1">${ia(f)} ${f===p?"⭐":""}</div>`),s+="</div></div>";else{let I;switch(a){case"linear":I=m;break;case"polynomial":I=f;break;default:I=p}I&&I.type&&(s+=`<div class="p-2 my-1 flex items-center" style="border-left: 3px solid ${c.borderColor};">
                    ${h}
                    <div>
                        <strong class="text-sm">${E}</strong>
                        <div class="text-xs ml-1 mt-1">${ia(I)}</div>
                    </div>
                </div>`)}}),o.innerHTML=i+s,o.classList.remove("hidden"),Ds()}function $t(e,t,o,n){if(t.length===0)return{};const a=t.map(g=>g.x),i=Math.min(...a),r=Math.max(...a)-i,l=e.type==="polynomial"?50:20,u=[];for(let g=0;g<=l;g++){const c=i+r*g/l;let m;if(e.type==="linear"){const{m:f,b:p}=e.coefficients;m=f*c+p}else{const{a:f,b:p,c:y}=e.coefficients;m=f*c*c+p*c+y}u.push({x:c,y:m})}return{label:`${e.type.charAt(0).toUpperCase()+e.type.slice(1)} Model`,data:u,type:"line",borderColor:o,borderWidth:2,borderDash:n==="dotted"?[5,5]:[],pointRadius:0,fill:!1,tension:e.type==="polynomial"?.1:0,order:1}}function ia(e){let t="";const o=e.type==="linear"?"L":"P";if(e.type==="linear"){const{m:n,b:a}=e.coefficients;t=`y = ${n.toFixed(4)}x ${a>=0?"+":"-"} ${Math.abs(a).toFixed(4)}`}else{const{a:n,b:a,c:i}=e.coefficients;t=`y = ${n.toFixed(4)}x² ${a>=0?"+":"-"} ${Math.abs(a).toFixed(4)}x ${i>=0?"+":"-"} ${Math.abs(i).toFixed(4)}`}return`<span class="font-mono">[${o}] ${t} (R² = ${e.r2.toFixed(4)})</span>`}function Ls(e=!0){const t=Ge();t&&(e?(t.destroy(),Hi(null)):(t.data.datasets=[],t.options.plugins.title.text="",t.options.plugins.title.display=!1,t.update())),U&&(U.innerHTML="",U.classList.add("hidden")),_o([]),we()}const zr=debounce(ea,400);function Zo(e){const t=ge();if(!t)return;const o=document.createElement("canvas"),n=o.getContext("2d",{willReadFrequently:!0});let a,i,s,r;if(e.type==="rect")a=Math.floor(e.x),i=Math.floor(e.y),s=Math.floor(e.width),r=Math.floor(e.height);else{const l=e.x+e.radius,u=e.y+e.radius;a=Math.floor(l-e.radius),i=Math.floor(u-e.radius),s=r=Math.floor(e.radius*2)}if(!(s<=0||r<=0)){o.width=s,o.height=r,n.drawImage(t,a,i,s,r,0,0,s,r);try{const l=n.getImageData(0,0,s,r),u=JSON.parse(JSON.stringify(e));window.dispatchEvent(new CustomEvent("process-roi-data",{detail:{roi:u,imageData:l}}))}catch(l){log("roiManager","error","Falha ao extrair ImageData para a ROI.",{roiId:e.id,error:l})}}}function Hr(e){log("roiManager","info","Iniciando adição de nova ROI (fase 1/2).",e);const t=Fo(),o={...e,id:t,name:`ROI ${t}`,customName:null,concentration:null,calibrationOrder:null,isSample:!1,useInCalibration:!1,isPositionLocked:!1,isSizeLocked:!1,isDetailsExpanded:!1,analyticalResponse:[],predictedConcentrations:[],sampleDescription:"",pixelCount:0,avgR:null,avgG:null,avgB:null,avgRGB:null,stdDevR_intra:null,stdDevG_intra:null,stdDevB_intra:null,lab:{},hsv:{},hsl:{},ycbcr:{}};if(o.type==="rect"&&(o.width<0&&(o.x+=o.width,o.width=Math.abs(o.width)),o.height<0&&(o.y+=o.height,o.height=Math.abs(o.height))),o.type==="rect"&&(o.width<3||o.height<3)||o.type==="circle"&&o.radius<2){log("roiManager","warn","ROI muito pequena para ser adicionada.",o);return}b().push(o),log("roiManager","info",`ROI ID ${t} adicionada ao estado (incompleta). Solicitando cálculo de dados.`),Zo(o),ee(),Ie(),Ke(t),Ts(),fe()}function ws(e){if(!e||e.length===0)return;log("roiManager","info",`Adicionando lote de ${e.length} ROIs.`);const t=[];return e.forEach(o=>{const n=Fo(),a={...o,id:n,name:`ROI ${n}`,customName:null,concentration:null,calibrationOrder:null,isSample:!1,useInCalibration:!1,isPositionLocked:!1,isSizeLocked:!1,isDetailsExpanded:!1,analyticalResponse:[],predictedConcentrations:[],sampleDescription:"",pixelCount:0,avgR:null,avgG:null,avgB:null};b().push(a),t.push(n),Zo(a)}),log("roiManager","info",`${t.length} ROIs do lote foram adicionadas (incompletas) e enviadas para processamento.`),t}function _r(){const e=$(),t=Array.from(e);if(t.length===0)return;const o=[];t.forEach(n=>{const a=b().find(i=>i.id===n);if(a){const i=Fo(),s={type:a.type,x:a.x+DUPLICATE_OFFSET,y:a.y+DUPLICATE_OFFSET,width:a.width,height:a.height,radius:a.radius,id:i,name:`ROI ${i}`,customName:null,concentration:null,calibrationOrder:null,isSample:!1,useInCalibration:!1,isPositionLocked:!1,isSizeLocked:!1,isDetailsExpanded:!1,analyticalResponse:[],predictedConcentrations:[],sampleDescription:"",pixelCount:0,avgR:null,avgG:null,avgB:null};b().push(s),o.push(i),Zo(s)}}),o.length>0&&(Ie(),o.forEach(n=>Ke(n)),ee(),fe(),ue(`${o.length} ROI(s) duplicada(s).`))}function ea(){log("roiManager","info","Solicitando recálculo de dados para todas as ROIs."),b().forEach(e=>{Object.assign(e,{pixelCount:0,avgR:null,avgG:null,avgB:null}),Zo(e)}),fe()}function Vr(e,t){const o=mt(),n=tr();if(!(!o||!n)){if(o.type==="rect")o.width=e-n.x,o.height=t-n.y;else if(o.type==="circle"){const a=e-n.x,i=t-n.y;o.radius=Math.hypot(a,i)/2,o.x=n.x+a/2-o.radius,o.y=n.y+i/2-o.radius}}}function Gr(e,t){const o=$();if(o.size!==1)return;const n=o.values().next().value,a=b().find(i=>i.id===n);if(!(!a||a.isSizeLocked)){if(a.type==="rect"){let{x:i,y:s,width:r,height:l}=a;switch(nr()){case"nw":r=a.x+a.width-e,l=a.y+a.height-t,i=e,s=t;break;case"n":l=a.y+a.height-t,s=t;break;case"ne":r=e-a.x,l=a.y+a.height-t,s=t;break;case"e":r=e-a.x;break;case"se":r=e-a.x,l=t-a.y;break;case"s":l=t-a.y;break;case"sw":r=a.x+a.width-e,l=t-a.y,i=e;break;case"w":r=a.x+a.width-e,i=e;break}r>1&&(a.x=i,a.width=r),l>1&&(a.y=s,a.height=l)}else if(a.type==="circle"){const i=a.x+a.radius,s=a.y+a.radius,r=Math.hypot(e-i,t-s),l=a.radius;a.radius=Math.max(1,r),a.x+=l-a.radius,a.y+=l-a.radius}}}function Wr(e){const t=$();t.size!==0&&(log("roiManager","info",`Redimensionando ${t.size} ROIs pelo fator: ${e.toFixed(3)}.`),t.forEach(o=>{const n=b().find(a=>a.id===o);if(!(!n||n.isSizeLocked)){if(n.type==="rect"){const a=n.x+n.width/2,i=n.y+n.height/2,s=n.width*e,r=n.height*e;if(s<3||r<3)return;n.width=s,n.height=r,n.x=a-s/2,n.y=i-r/2}else if(n.type==="circle"){const a=n.x+n.radius,i=n.y+n.radius,s=n.radius*e;if(s<2)return;n.radius=s,n.x=a-s,n.y=i-s}}}))}function Yr(e,t){const o=or();if(!o||!o.mousePos||!o.roiPositions)return;const n=e-o.mousePos.x,a=t-o.mousePos.y;o.roiPositions.forEach(i=>{const s=b().find(r=>r.id===i.id);s&&!s.isPositionLocked&&(s.x=i.x+n,s.y=i.y+a)})}function Ur(e){log("roiManager","info",`Rotacionando todas as ROIs 90 graus. Altura original da imagem: ${e}`);const t=b();if(!t||t.length===0){log("roiManager","info","Nenhuma ROI para rotacionar.");return}t.forEach(o=>{let n,a;o.type==="rect"?(n=o.x+o.width/2,a=o.y+o.height/2):(n=o.x+o.radius,a=o.y+o.radius);const i=e-a,s=n;if(o.type==="rect"){const r=o.width;o.width=o.height,o.height=r,o.x=i-o.width/2,o.y=s-o.height/2}else o.x=i-o.radius,o.y=s-o.radius}),log("roiManager","info","ROIs rotacionadas com sucesso."),ea()}function Je(){log("roiManager","info","Agendando atualização completa da UI após modificação de ROIs."),Ts(),fe()}function Xr(e){log("roiManager","info",`Tentando excluir ROI ID: ${e}`);const t=b(),o=t.findIndex(n=>n.id===e);o!==-1&&(t[o].id===w()&&Ye(null),cr(e),t.splice(o,1),ee(),Je())}async function ks(){const e=$(),t=e.size;if(t===0)return;if(t>1)try{await Za("Confirmar Exclusão Múltipla",`Tem certeza que deseja excluir as ${t} ROIs selecionadas?`)}catch{log("roiManager","info","Exclusão de múltiplas ROIs cancelada pelo usuário.");return}log("roiManager","warn",`Excluindo ${t} ROI(s) selecionada(s).`);const o=b().filter(i=>!e.has(i.id));bn(o),e.has(w())&&Ye(null),Ie(),ee(),Je();const n=t>1?"s":"",a=t>1?"s":"a";ue(`${t} ROI${n} excluída${a}.`)}async function jr(){try{await Za("Excluir Todas as ROIs",`Tem certeza que deseja excluir TODAS as ${b().length} ROIs? Esta ação não pode ser desfeita.`,{confirmText:"Excluir Tudo"}),log("roiManager","warn",`Excluindo TODAS as ${b().length} ROIs e resetando estado analítico completo.`),ji(),_o([]),Ls(!0),Jo(),Je(),ue("Todas as ROIs e dados de análise foram limpos.")}catch{log("roiManager","info","Exclusão de todas as ROIs cancelada pelo usuário.")}}function yi(e){const t=b().find(o=>o.id===e);t&&(log("roiManager","info",`Alternando estado de Branco para ROI ID ${e}.`),w()===e?Ye(null):(t.isSample&&(t.isSample=!1),Ye(e)),ee(),Je())}function Qr(e){const t=b().find(o=>o.id===e);t&&(log("roiManager","info",`Alternando estado de Amostra para ROI ID ${e}.`),t.isSample=!t.isSample,t.isSample&&t.id===w()&&Ye(null),ee(),Je())}function Kr(){const e=$();if(e.size===0)return;const t=Array.from(e).map(n=>b().find(a=>a.id===n)).filter(Boolean),o=t.every(n=>n.isSample);t.forEach(n=>{n.isSample=!o,n.isSample&&n.id===w()&&Ye(null)}),ee(),Je()}function Jr(){log("roiManager","warn","Limpando todas as concentrações das ROIs de calibração."),b().forEach(e=>{e.calibrationOrder!==null&&(e.concentration=null)}),Je(),ue("Concentrações limpas.")}function Zr(e,t){const o=b().find(n=>n.id===e);o&&(o.customName=t,log("roiManager","info",`Nome da ROI ID ${e} atualizado para: "${t}".`),fe())}function el(e){const t=b().find(n=>n.id===e);if(!t)return;const o=!(t.isPositionLocked&&t.isSizeLocked);t.isPositionLocked=o,t.isSizeLocked=o,log("roiManager","info",`Trava de Posição/Tamanho para ROI ID ${e} definida como: ${o}.`),fe()}function tl(){const e=$();if(e.size===0)return;const t=Array.from(e).map(n=>b().find(a=>a.id===n)).filter(Boolean),o=t.every(n=>n.isPositionLocked);t.forEach(n=>n.isPositionLocked=!o),log("roiManager","info",`Trava de Posição para ${e.size} ROIs definida como: ${!o}.`),fe()}function nl(){const e=$();if(e.size===0)return;const t=Array.from(e).map(n=>b().find(a=>a.id===n)).filter(Boolean),o=t.every(n=>n.isSizeLocked);t.forEach(n=>n.isSizeLocked=!o),log("roiManager","info",`Trava de Tamanho para ${e.size} ROIs definida como: ${!o}.`),fe()}function ee(){log("roiManager","info","Revisando e consolidando a ordem de calibração para ROIs padrão.");const e=b(),t=e.filter(n=>!n.isSample&&n.id!==w()),o=e.filter(n=>n.isSample||n.id===w());log("roiManager","data",`Encontradas ${t.length} ROIs padrão para renumeração.`),t.forEach((n,a)=>{const i=a+1;n.calibrationOrder!==i&&(log("roiManager","data",`Atualizando ordem da ROI ${n.id} de ${n.calibrationOrder} para ${i}.`),n.calibrationOrder=i),n.customName||(n.name=`Padrão ${i}`)}),o.forEach(n=>{n.calibrationOrder!==null&&(log("roiManager","data",`Removendo ordem de calibração da ROI ${n.id} (Amostra ou Branco).`),n.calibrationOrder=null)}),log("roiManager","info","Consolidação da ordem de calibração finalizada.")}function ol(e,t,o){if(o.type==="rect")return e>=o.x&&e<=o.x+o.width&&t>=o.y&&t<=o.y+o.height;{const n=o.x+o.radius,a=o.y+o.radius;return Math.hypot(e-n,t-a)<=o.radius}}function al(e){for(const t of Object.values(analyticalEquationsBySystem))for(const o of Object.values(t)){const n=o.find(a=>a.id===e);if(n)return n}return null}function As(e){if(typeof renderMathInElement=="function")try{log("modalManager","info","KaTeX encontrado. Renderizando fórmulas matemáticas."),renderMathInElement(e,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})}catch(t){log("modalManager","error","Ocorreu um erro ao renderizar as fórmulas com KaTeX.",t)}else log("modalManager","warn","Função renderMathInElement (KaTeX) não foi encontrada. As fórmulas não serão renderizadas em formato rico.")}function R(e){if(!xe)return;log("modalManager","info","Exibindo modal geral:",e),Vo.textContent=e,Go.classList.add("hidden"),Te.style.display="block",xe.dataset.visible="true";const t=()=>{xe.dataset.visible="false",Te.removeEventListener("click",t)};Te.addEventListener("click",t,{once:!0}),setTimeout(()=>Te.focus(),100)}function Ze(e){xe&&(log("modalManager","info","Exibindo modal de carregamento:",e),Vo.textContent=e,Go.classList.remove("hidden"),Te.style.display="none",xe.dataset.visible="true")}function mn(){xe&&(log("modalManager","info","Ocultando modal de carregamento/mensagem."),xe.dataset.visible="false")}function ue(e){if(!Tt)return;Aa.textContent=e,Tt.classList.remove("hidden");const t=()=>{Tt.classList.add("hidden"),Vn.removeEventListener("click",t)};Vn.addEventListener("click",t,{once:!0}),setTimeout(t,5e3)}function Za(e,t,o={}){return log("modalManager","info","Abrindo modal de confirmação:",{title:e,message:t}),new Promise((n,a)=>{if(!qt)return a(new Error("Modal de confirmação não encontrado no DOM."));Da.textContent=e,Oa.textContent=t,st.textContent=o.confirmText||"Confirmar",Ft.textContent=o.cancelText||"Cancelar";const i=()=>{log("modalManager","info","Ação confirmada pelo usuário."),r(),n()},s=()=>{log("modalManager","info","Ação cancelada pelo usuário."),r(),a(new Error("Ação cancelada pelo usuário."))},r=()=>{st.removeEventListener("click",i),Ft.removeEventListener("click",s),io.removeEventListener("click",s),qt.dataset.visible="false"};st.addEventListener("click",i,{once:!0}),Ft.addEventListener("click",s,{once:!0}),io.addEventListener("click",s,{once:!0}),qt.dataset.visible="true",setTimeout(()=>st.focus(),100)})}function il(e){return log("modalManager","info",`Abrindo modal para editar nome da ROI ID: ${e}`),new Promise((t,o)=>{const n=b().find(r=>r.id===e);if(!n||!Dt)return o("ROI ou modal não encontrado.");Ot.value=n.customName||n.name,Gn.textContent="";const a=r=>{r.preventDefault();const l=Ot.value.trim();if(!l){Gn.textContent="O nome não pode estar em branco.";return}Zr(e,l),s(),t(l)},i=()=>{s(),o("Edição de nome cancelada.")},s=()=>{Wn.removeEventListener("click",a),Yn.removeEventListener("click",i),Un.removeEventListener("click",i),Dt.dataset.visible="false"};Wn.addEventListener("click",a,{once:!0}),Yn.addEventListener("click",i,{once:!0}),Un.addEventListener("click",i,{once:!0}),Dt.dataset.visible="true",Ot.focus()})}function fn(e,t){if(!F){log("modalManager","error","Modal de informações genérico não encontrado no DOM.");return}log("modalManager","info",`Abrindo modal de informações: "${e}"`),sn.textContent=e;const o=F.querySelector(".modal-content > .space-y-4");if(o)o.innerHTML=`<div class="text-sm text-gray-700 leading-relaxed">${t}</div>`;else{log("modalManager","error","Corpo do modal de informações não encontrado para inserir conteúdo.");return}F.dataset.visible="true";const n=()=>{F.dataset.visible="false"};an.addEventListener("click",n,{once:!0})}function sl(e){if(!F){log("modalManager","error","Elementos do DOM para o modal de informações da métrica não foram encontrados.");return}const t=al(e);if(!t){log("modalManager","error",`Métrica com ID "${e}" não encontrada para exibir detalhes.`),R("Não foi possível encontrar os detalhes para esta métrica.");return}log("modalManager","info",`Abrindo modal de informações para a métrica: ${t.fullName}`);const o=F.querySelector(".modal-content > .space-y-4");sn.textContent=t.fullName,o&&(o.innerHTML=`
            <div>
                <strong class="block text-sm font-medium text-gray-600">Fórmula:</strong>
                <div class="mt-1 text-sm p-2 bg-gray-100 rounded-md font-mono">${t.formula||"N/A"}</div>
            </div>
            <div>
                <strong class="block text-sm font-medium text-gray-600">Descrição e Propósito:</strong>
                <p class="mt-1 text-sm text-gray-700 leading-relaxed">${t.description||"Descrição não disponível."}</p>
            </div>
        `,As(o)),F.dataset.visible="true";const n=()=>{F.dataset.visible="false"};an.addEventListener("click",n,{once:!0})}function rl(e,t){if(!F){log("modalManager","error","Modal de informações não encontrado para exibir detalhes de qualidade.");return}log("modalManager","info",`Abrindo modal de informações de qualidade: ${e}`),sn.textContent=e;const o=F.querySelector(".modal-content > .space-y-4");if(!o){log("modalManager","error","Corpo do modal de informações não encontrado.");return}o.innerHTML="",t.forEach(a=>{const i=document.createElement("div");i.className="py-3 border-b last:border-b-0",i.innerHTML=`
            <h4 class="text-md font-semibold text-sky-800">${a.title}</h4>
            <div class="mt-2 space-y-3 pl-2">
                <div>
                    <strong class="block text-xs font-medium text-gray-500">Descrição e Relevância Analítica:</strong>
                    <p class="mt-1 text-sm text-gray-700 leading-relaxed">${a.description||"N/A"}</p>
                </div>
                <div>
                    <strong class="block text-xs font-medium text-gray-500">Fórmula:</strong>
                    <div class="mt-1 text-sm p-2 bg-gray-100 rounded-md font-mono">${a.formula||"N/A"}</div>
                </div>
            </div>
        `,o.appendChild(i)}),F.dataset.visible="true";const n=()=>{F.dataset.visible="false"};an.addEventListener("click",n,{once:!0}),As(o)}let sa=!1;function ll(e){return new Promise((t,o)=>{const n=b().find(r=>r.id===e);if(!n)return log("modalManager","warn",`_showModalForSingleRoi: ROI com ID ${e} não encontrada na fila.`),o("ROI não encontrada para o modal.");log("modalManager","info",`Abrindo modal de concentração para ROI: ${n.name} (ID: ${e})`),pi(e),$a.textContent=n.customName||n.name,at.value=n.concentration??"",Qn.textContent="",Xn.dataset.visible="true",at.focus(),at.select();const a=r=>{r.preventDefault(),r.stopPropagation();const l=at.value.trim(),u=l===""?null:parseFloat(l.replace(",","."));if(l!==""&&isNaN(u)){Qn.textContent="Por favor, insira um número válido.";return}log("modalManager","data",`Concentração definida para ROI ID ${e}: ${u}`),n.concentration=u,u!==null&&(n.useInCalibration=!0),s(),t(!0)},i=r=>{r.stopPropagation(),log("modalManager","info","Abertura do modal de concentração cancelada pelo usuário."),s(),o("Modal de concentração cancelado.")},s=()=>{jn.removeEventListener("submit",a),Kn.removeEventListener("click",i),Jn.removeEventListener("click",i),Xn.dataset.visible="false",pi(null)};jn.addEventListener("submit",a),Kn.addEventListener("click",i,{once:!0}),Jn.addEventListener("click",i,{once:!0})})}async function $s(){if(sa){log("modalManager","warn","Tentativa de processar a fila enquanto já estava em andamento. Ignorado.");return}const e=ar();if(e.length!==0){for(log("modalManager","info",`Iniciando processamento da fila de concentração com ${e.length} item(ns).`),sa=!0;e.length>0;){const t=e.shift();try{await ll(t)}catch(o){log("modalManager","info","Fila de concentração interrompida pelo usuário.",o),Ia([]);break}}sa=!1,log("modalManager","info","Processamento da fila de concentração finalizado. Atualizando a UI."),H()}}function vi(){if(!ve)return;const e=Ga.checked,t=Ko.checked,o=ve.querySelector("#readDirectionFieldset"),n=e?`<label class="flex items-center p-2 border rounded-lg cursor-pointer flex-1 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300"><input type="radio" name="scan_direction" value="top_to_bottom" class="form-radio mr-2" checked> De Cima para Baixo</label>
           <label class="flex items-center p-2 border rounded-lg cursor-pointer flex-1 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300"><input type="radio" name="scan_direction" value="bottom_to_top" class="form-radio mr-2"> De Baixo para Cima</label>`:`<label class="flex items-center p-2 border rounded-lg cursor-pointer flex-1 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300"><input type="radio" name="scan_direction" value="left_to_right" class="form-radio mr-2" checked> Da Esquerda para Direita</label>
           <label class="flex items-center p-2 border rounded-lg cursor-pointer flex-1 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300"><input type="radio" name="scan_direction" value="right_to_left" class="form-radio mr-2"> Da Direita para Esquerda</label>`,a=e?`<label class="flex items-center p-2 border rounded-lg cursor-pointer flex-1 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300"><input type="radio" name="read_direction" value="left_to_right" class="form-radio mr-2" checked> Da Esquerda para Direita</label>
           <label class="flex items-center p-2 border rounded-lg cursor-pointer flex-1 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300"><input type="radio" name="read_direction" value="right_to_left" class="form-radio mr-2"> Da Direita para Esquerda</label>`:`<label class="flex items-center p-2 border rounded-lg cursor-pointer flex-1 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300"><input type="radio" name="read_direction" value="top_to_bottom" class="form-radio mr-2" checked> De Cima para Baixo</label>
           <label class="flex items-center p-2 border rounded-lg cursor-pointer flex-1 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300"><input type="radio" name="read_direction" value="bottom_to_top" class="form-radio mr-2"> De Baixo para Cima</label>`;Wa.innerHTML=n,Ya.innerHTML=a,o&&(o.disabled=t,o.style.opacity=t?.5:1)}function cl(e,t,o){if(!Vt)return;log("modalManager","info","Abrindo modal avançado de sequenciamento."),vi();const n=l=>{l.preventDefault();const u=new FormData(ve),g={pattern:u.get("sequence_pattern"),scan:u.get("scan_direction"),read:u.get("read_direction"),serpentine:Ko.checked};e(g),r()},a=()=>{t(),r()},i=()=>{o&&o(),r()},s=l=>{(l.target.name==="sequence_pattern"||l.target.id==="sequenceSerpentineToggle")&&vi()},r=()=>{ve.removeEventListener("change",s),ve.removeEventListener("submit",n),Mo.removeEventListener("click",i),Co.removeEventListener("click",i),Bo.removeEventListener("click",a),Vt.dataset.visible="false"};ve.addEventListener("change",s),ve.addEventListener("submit",n),Mo.addEventListener("click",i,{once:!0}),Co.addEventListener("click",i,{once:!0}),Bo.addEventListener("click",a,{once:!0}),Vt.dataset.visible="true"}function dl(){return log("modalManager","info","Abrindo modal para definir dimensões da grade."),new Promise((e,t)=>{if(!zt)return t("Modal não encontrado.");const o=va();Ht.value=o.rows,ro.value=o.cols,_t.classList.add("hidden");const n=s=>{s.preventDefault();const r=parseInt(Ht.value,10),l=parseInt(ro.value,10);if(isNaN(r)||isNaN(l)||r<2||l<2){_t.textContent="Linhas e colunas devem ser números maiores que 1.",_t.classList.remove("hidden");return}i(),e({rows:r,cols:l})},a=()=>{i(),t("Cancelado pelo usuário.")},i=()=>{so.removeEventListener("submit",n),lo.removeEventListener("click",a),co.removeEventListener("click",a),zt.dataset.visible="false"};so.addEventListener("submit",n),lo.addEventListener("click",a,{once:!0}),co.addEventListener("click",a,{once:!0}),zt.dataset.visible="true",Ht.focus()})}function Ps(e,t){return log("modalManager","info","Abrindo modal de input de texto:",e),new Promise((o,n)=>{if(!Nt)return n("Modal de texto não encontrado");Pa.textContent=e,it.value=t||"",Ta.textContent="";const a=r=>{r.preventDefault();const l=it.value;s(),o(l)},i=()=>{s(),n("Input de texto cancelado.")},s=()=>{Zn.removeEventListener("submit",a),eo.removeEventListener("click",i),to.removeEventListener("click",i),Nt.dataset.visible="false"};Zn.addEventListener("submit",a),eo.addEventListener("click",i,{once:!0}),to.addEventListener("click",i,{once:!0}),Nt.dataset.visible="true",it.focus(),it.select()})}function Ts(){zo()&&!Di()&&(log("analysisManager","warn","Análise invalidada devido a modificações. Recalcular métricas."),Vi(!0),ue("Atenção: A análise está desatualizada. Recalcule as métricas."),log("analysisManager","info","Executando atualização granular da UI para invalidar análise."),ta(),rn())}let Ae=null,ra=!1;function Ds(){if(!He)return;const t=D().length>1;if(He.classList.toggle("hidden",!t),t){const o=ha(),n=He.querySelector(`input[value="${o}"]`);n&&(n.checked=!0)}}function Os(){log("uiManager","info",`Atualizando visuais das ferramentas. Ferramenta: '${gt()}', Modo App: '${z()}', MultiSelect: ${J()}`);const e=J(),t=gt(),o=(n,a,i=null)=>{n&&(n.dataset.toolState=a?"active":"inactive",i!==null&&(n.textContent=i))};if(e)o(Re,!0,"Sair da Seleção"),o(ie,!1),o(se,!1),ie&&(ie.disabled=!0),se&&(se.disabled=!0);else{Re&&(Re.textContent="Ponteiro");const n=tn();ie&&(ie.disabled=!n),se&&(se.disabled=!n),o(Re,t==="pointer"),o(ie,t==="rect"),o(se,t==="circle")}if(C){const n={rect:"crosshair",circle:"crosshair",pointer:"grab"};C.style.cursor=n[t]||"default"}}function rn(){log("uiManager","info","Atualizando estado dos botões."),Os();const e=b(),t=e.length>0,o=tn(),n=$(),a=n.size;if(ft&&(ft.disabled=!o),ht&&(ht.disabled=!o),pt&&(pt.disabled=!o),yt&&(yt.disabled=!t),Ct&&(Ct.disabled=!o),Oe){const r=typeof cv<"u"&&cv.Mat;Oe.disabled=!o||!r||J(),Oe.title=!r&&o?"Aguardando carregamento do OpenCV...":"Detecção Automática de ROIs"}if(ka){const r=document.getElementById("dynamicActionsFieldset");if(r&&(r.disabled=a===0),a>0){const l=Array.from(n).map(u=>e.find(g=>g.id===u)).filter(Boolean);if(l.length===a){const u=a===1;Ut.textContent=l.every(g=>g.isSample)?"Remover Amostra":"Definir Amostra",vt.disabled=!u,u&&(vt.textContent=l[0].id===w()?"Remover Branco":"Definir Branco"),Xt.textContent=l.every(g=>g.isPositionLocked)?"Desbloq. Posição":"Travar Posição",jt.textContent=l.every(g=>g.isSizeLocked)?"Desbloq. Tamanho":"Travar Tamanho",Qt.disabled=l.filter(g=>!g.isSample).length<2}}}const i=zo(),s=D().length>0;St&&(St.disabled=!i),Et&&(Et.disabled=!s),It&&(It.disabled=!s),zn&&(zn.disabled=e.filter(r=>!r.isSample&&r.id!==w()).length<2)}function ta(){log("uiManager","info","Atualizando abas de análise."),we(),Ja(),Bs(),Tr()}function na(){log("uiManager","info","Atualizando lista de ROIs."),$r()}function kt(){log("uiManager","info","Atualizando chrome da UI (painéis, overlays)."),fl(),pl(),Ns();const e=J(),t=Ce()!==null;if(K){let o="idle";e?o="multiselect":t&&(o="editing"),K.dataset.interactionState=o,log("uiManager","data",`Estado de interação do canvas definido como: '${o}'`)}}function oa(){log("uiManager","perf","Executando atualização visual de seleção (otimizada)."),Ar(),rn(),Ns(),A()}function H(){log("uiManager","info","Executando atualização completa da UI (uso moderado)."),kt(),rn(),na(),ta(),A()}function fe(){ra||(ra=!0,log("uiManager","perf","Agendando atualização da UI para o próximo quadro."),requestAnimationFrame(()=>{log("uiManager","perf","Executando atualização agendada da UI."),H(),ra=!1}))}function ul(){log("uiManager","info","Inicializando a UI com estado padrão."),rn(),na(),ta(),A()}function gl(e){sr()!==e&&(log("uiManager","info",`Trocando para a aba: ${e}`),ml(e),yr(e))}function ml(e){document.querySelectorAll(".tab-button").forEach(t=>{t.classList.toggle("active",t.dataset.tab===e)}),wa.forEach(t=>{t.classList.toggle("hidden",t.id!==`tab-${e}`)})}function _e(e){e&&(log("uiManager","info",`Ferramenta alterada para: ${e}.`),e==="pointer"&&J()&&(log("uiManager","info","Saindo do modo de multisseleção."),Ra(!1),oa()),lr(e),xn(null),Os())}function fl(){const e=z(),t=e==="selectingGridCorners"||e==="adjustingGrid"||e==="sequencingRois";de&&(de.classList.toggle("hidden",!t),de.classList.toggle("instruction-bar",t)),e==="adjustingGrid"?(re&&re.classList.remove("hidden"),q&&q.classList.add("hidden")):e==="selectingGridCorners"||e==="sequencingRois"?(re&&re.classList.add("hidden"),q&&q.classList.remove("hidden")):(re&&re.classList.add("hidden"),q&&q.classList.add("hidden"))}function pl(){if(!bt||!Ne||!xt)return;bt.classList.toggle("active",Yt());const e=on();xt.classList.toggle("active",e),An&&(An.innerHTML=e?'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>':'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path>');const t=ba();Ne.querySelector("svg")&&(Ne.querySelector("svg").innerHTML=t?'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 3h6m0 0v6m0-6l-7 7M9 21H3m0 0v-6m0 6l7-7"></path>':'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1v4m0 0h-4m4 0l-5-5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5-5"></path>');const o=de&&!de.classList.contains("hidden"),n=K.querySelector("#canvas-controls-overlay");if(n){let a=8;t&&o&&(a+=de.clientHeight),n.style.top=`${a}px`}Be&&Be.classList.toggle("displaced-by-bar",t&&o)}function we(){log("uiManager","info","Atualizando visibilidade dos passos de análise.");const e=zo();vn(2,e);const t=ei().length>0;vn(3,t);const o=D().length>0;vn(5,o),Hn&&Hn.classList.toggle("hidden",!e),_n&&_n.classList.toggle("hidden",!Di()),ln(),Ds()}function vn(e,t){const o=aa[`step${e}Wrapper`],n=aa[`step${e}Content`],a=aa[`step${e}Blocker`];o&&(o.disabled=!t),n&&n.classList.toggle("hidden",!t),a&&a.classList.toggle("hidden",t)}function ei(){return O?Array.from(O.querySelectorAll('input[type="checkbox"]:checked')).map(e=>e.value):[]}function ln(){const e=b().filter(n=>n.useInCalibration&&n.concentration!==null).length,t=ei().length>0,o=e>=2&&t;log("uiManager","info",`Verificando estado do botão de calibração. Pontos válidos: ${e}, Parâmetros selecionados: ${t}. Passo 4 Habilitado: ${o}.`),vn(4,o)}function To(e){kn&&(kn.textContent=e)}function Ns(){const e=j(),t=Kt;if(t){if(J()){t.classList.add("hidden");return}if(e.visible&&e.roiId!==null){const o=b().find(g=>g.id===e.roiId);if(!o){t.classList.add("hidden");return}const n=Jt.querySelector("svg");if(n){const g=o.isPositionLocked&&o.isSizeLocked;n.innerHTML=g?'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>':'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path>'}Fe.disabled=o.isSample,Fe.style.opacity=o.isSample?"0.5":"1",Fe.style.cursor=o.isSample?"not-allowed":"pointer";const a=15,i=10,s=t.getBoundingClientRect(),r=document.body.getBoundingClientRect();let l=e.x+a,u=e.y+i;l+s.width>r.width&&(l=e.x-s.width-a),u+s.height>r.height&&(u=e.y-s.height),t.style.left=`${l}px`,t.style.top=`${u}px`,t.classList.remove("hidden")}else t.classList.add("hidden")}}function hl(){Ae&&clearInterval(Ae),Ae=setInterval(()=>{typeof cv<"u"&&cv.Mat&&(rn(),clearInterval(Ae),Ae=null)},250),setTimeout(()=>{Ae&&clearInterval(Ae)},1e4)}let ae=null,dt=[],ma=null,fa=null;function yl(e,t){log("sequenceManager","info","Iniciando ordenação automática com opções:",e);const o=b();let n=t.map(h=>o.find(x=>x.id===h)).filter(Boolean);if(n.length===0){log("sequenceManager","warn","Nenhuma ROI válida encontrada para ordenação.");return}log("sequenceManager","data",`${n.length} ROIs a serem ordenadas.`);const i=(n.reduce((h,x)=>h+(x.radius||0),0)/n.length||10)*1.5,s=e.pattern==="horizontal"?"y":"x",r=e.pattern==="horizontal"?"x":"y",l=[];let u=[...n];for(;u.length>0;){let h=u.shift(),x=[h],E=[];for(const I of u)Math.abs(I[s]-h[s])<i?x.push(I):E.push(I);l.push(x),u=E}const g=e.scan==="bottom_to_top"||e.scan==="right_to_left"?-1:1;l.sort((h,x)=>{const E=h.reduce((M,S)=>M+S[s],0)/h.length,I=x.reduce((M,S)=>M+S[s],0)/x.length;return(E-I)*g});const c=e.read==="right_to_left"||e.read==="bottom_to_top"?-1:1,m=[];l.forEach((h,x)=>{let E=c;e.serpentine&&x%2!==0&&(E*=-1),h.sort((I,M)=>(I[r]-M[r])*E),m.push(...h)});const f=new Set(m.map(h=>h.id)),y=[...o.filter(h=>!f.has(h.id)),...m];bn(y),log("sequenceManager","data","Nova ordem de ROIs no estado:",y.map(h=>h.id)),ee()}function vl(){_e("pointer"),K&&K.scrollIntoView({behavior:"smooth",block:"center"}),Br(),bl(),ni(),H(),A()}function ti(e=null){return new Promise((t,o)=>{ma=t,fa=o;const n=b().filter(a=>!a.isSample&&a.id!==w());if(e&&e.size>0?dt=n.filter(a=>e.has(a.id)):dt=n,dt.length<2)return R("São necessárias pelo menos 2 ROIs de calibração para definir uma ordem."),o(new Error("ROIs de calibração insuficientes."));cl(a=>{const i=dt.map(s=>s.id);yl(a,i),t({status:"completed"})},()=>{vl()},()=>{o(new Error("Sequencing modal cancelled by user."))})})}function ni(){const e=dt.length,t=nn().length,o=t+1;t>=e?To('Sequência completa! Clique em "Concluir".'):To(`Toque na ROI que corresponde ao Ponto de Calibração Nº ${o}`)}function bl(){de&&(q&&q.classList.add("hidden"),ae&&qs(),ae=document.createElement("div"),ae.id="sequence-controls-container",ae.className="flex items-center gap-2",ae.innerHTML=`
        <button id="undoSequenceButton" class="px-3 py-1 bg-yellow-500 text-white rounded-md text-xs hover:bg-yellow-600">Desfazer</button>
        <button id="finishSequenceButton" class="px-3 py-1 bg-green-600 text-white rounded-md text-xs hover:bg-green-700">Concluir</button>
        <button id="cancelSequenceButton" class="px-3 py-1 bg-red-500 text-white rounded-md text-xs hover:bg-red-600">Cancelar</button>
    `,de.querySelector(".container").appendChild(ae),document.getElementById("undoSequenceButton").addEventListener("click",Il),document.getElementById("finishSequenceButton").addEventListener("click",El),document.getElementById("cancelSequenceButton").addEventListener("click",()=>oi(!1)),ae.classList.remove("hidden"),document.getElementById("undoSequenceButton").disabled=nn().length===0)}function qs(){ae&&(ae.remove(),ae=null),q&&q.classList.remove("hidden")}function xl(e){z()!=="sequencingRois"||!dt.some(o=>o.id===e)||nn().includes(e)||(Lr(e),ni(),document.getElementById("undoSequenceButton").disabled=!1,A())}function Il(){wr(),ni(),document.getElementById("undoSequenceButton").disabled=nn().length===0,A()}function El(){Mr(),ee(),oi(!0)}function oi(e=!1){const t=e?ma:fa,o=e?{status:"completed"}:new Error("Manual sequencing cancelled.");ga(),qs(),A(),typeof t=="function"&&t(o),ma=null,fa=null}function Fs(){z()==="adjustingGrid"&&(A(),requestAnimationFrame(Fs))}function Sl(){if(log("autoRoiDetector","info","Iniciando modo de detecção avançada."),!ge()){R("Carregue uma imagem antes de detectar ROIs.");return}_e("pointer");const e=(n,a)=>{let i=parseFloat(n.value).toFixed(n.id.includes("circularity")?2:0);a.textContent=`Valor: ${i}`};[{slider:wo,display:Ua},{slider:ko,display:Xa},{slider:Ao,display:ja},{slider:$o,display:Qa}].forEach(({slider:n,display:a})=>{n&&a&&(e(n,a),n.oninput=()=>e(n,a))});const o=()=>{log("autoRoiDetector","info","Fechando modal de configurações de detecção avançada."),rt&&(rt.dataset.visible="false"),ct&&(ct.onclick=null),lt&&(lt.onclick=null)};rt&&(log("autoRoiDetector","info","Abrindo modal de configurações de detecção avançada."),rt.dataset.visible="true"),ct&&(ct.onclick=()=>{const n={minSaturation:parseFloat(wo.value),minValue:parseFloat(ko.value),minArea:parseInt(Ao.value,10),minCircularity:parseFloat($o.value)};o(),Ze("Analisando imagem em segundo plano...");try{const a=ge(),s=a.getContext("2d").getImageData(0,0,a.width,a.height);log("autoRoiDetector","info","Disparando evento para detecção de círculos no worker.",{settings:n}),window.dispatchEvent(new CustomEvent("request-circle-detection",{detail:{imageData:s,settings:n}}))}catch(a){log("autoRoiDetector","error","Erro ao preparar dados para o worker:",a),R("Ocorreu um erro ao preparar a imagem para análise.")}}),lt&&(lt.onclick=o)}const zs=["Toque no centro do poço do CANTO SUPERIOR ESQUERDO (Ponto 1)","Toque no centro do poço do CANTO SUPERIOR DIREITO (Ponto 2)","Toque no centro do poço do CANTO INFERIOR DIREITO (Ponto 3)","Toque no centro do poço do CANTO INFERIOR ESQUERDO (Ponto 4)","Ajuste os cantos arrastando-os e clique em [Confirmar Grade]"];function Rl(){if(log("autoRoiDetector","info","Iniciando análise de grade."),!ge()){R("Carregue uma imagem antes de iniciar a análise de grade.");return}_e("pointer"),Cl()}async function Cl(){try{const{rows:e,cols:t}=await dl();log("autoRoiDetector","info",`Dimensões da grade definidas: ${e}x${t}. Iniciando seleção de cantos.`),xr({rows:e,cols:t}),Wi(),Sa("selectingGridCorners"),To(zs[0]),H()}catch{log("autoRoiDetector","info","Entrada de dimensões da grade cancelada pelo usuário.")}}function Ml(e){vr(e),log("autoRoiDetector","info","Ponto de canto da grade adicionado:",e)}function Bl(){const e=Ho(),t=zs[e.length];To(t),log("autoRoiDetector","info",`Canto ${e.length}/4 selecionado. Próxima instrução: ${t}`),e.length===4&&(log("autoRoiDetector","info","Todos os 4 cantos selecionados. Entrando no modo de ajuste."),Sa("adjustingGrid"),H(),Fs())}function Ll(){log("autoRoiDetector","info","Grade confirmada pelo usuário. Rodando análise...");const e=va();e?wl(e.rows,e.cols):(log("autoRoiDetector","error","Não foi possível encontrar as dimensões da grade no estado da aplicação."),R("Erro: dimensões da grade não encontradas. Por favor, cancele e tente novamente."))}function Wt(){log("autoRoiDetector","info","Seleção de grade cancelada."),re&&re.classList.add("hidden"),Sa("idle"),Wi(),kt(),A()}async function wl(e,t){try{const o=Ho();if(o.length!==4)return;log("autoRoiDetector","info",`Gerando grade de ${e}x${t} ROIs.`),o.sort((f,p)=>f.y-p.y);const n=[o[0],o[1]].sort((f,p)=>f.x-p.x),a=[o[2],o[3]].sort((f,p)=>f.x-p.x),[i,s]=n,[r,l]=a,u=[],g=(s.x-i.x+(l.x-r.x))/2,c=(r.y-i.y+(l.y-s.y))/2,m=Math.min(g/(t-1),c/(e-1))/5;for(let f=0;f<e;f++){const p=e>1?f/(e-1):0,y=i.x+(r.x-i.x)*p,h=i.y+(r.y-i.y)*p,x=s.x+(l.x-s.x)*p,E=s.y+(l.y-s.y)*p;for(let I=0;I<t;I++){const M=t>1?I/(t-1):0,S=y+(x-y)*M,B=h+(E-h)*M;u.push({type:"circle",x:S-m,y:B-m,radius:m})}}if(u.length>0){log("autoRoiDetector","info",`${u.length} ROIs geradas com sucesso a partir da grade.`);const f=ws(u),p=new Set(f);Wt();try{await ti(p),log("autoRoiDetector","info","Sequenciamento customizado concluído pelo usuário.")}catch(y){log("autoRoiDetector","warn","Usuário cancelou a ordenação customizada. Aplicando ordenação padrão.",y.message),ee()}H(),ue(`${u.length} ROIs criadas e ordenadas!`)}else log("autoRoiDetector","warn","Nenhuma ROI foi gerada pela análise de grade."),R("Nenhuma ROI foi gerada pela análise de grade."),Wt()}catch(o){log("autoRoiDetector","error","Erro na análise de grade:",o),R("Ocorreu um erro durante a análise de grade."),Wt()}}function kl(){log("autoRoiDetector","info","Função 'Detectar em Área' chamada (ainda não implementada)."),R("Função 'Detectar em Área' será implementada em breve!")}let Y=null,v=null,ye=null,G=null;const Al=400;let k={isActionInitiated:!1,isPanningWithSpace:!1,startPos:null,clickedRoiOnStart:null},Lt=!1,N={x:0,y:0,width:0,height:0},Pt=null,la=null;function $l(e){if(!e||!ye||!ge()||!Be)return;const t=Be.clientWidth;if(qe.width!==t&&(qe.width=t,qe.height=t),t===0)return;const o=t,n=1.2,a=ge();ye.fillStyle="white",ye.fillRect(0,0,o,o),ye.save(),ye.scale(n,n);const i=o/n,s=e.x-i/2,r=e.y-i/2;ye.translate(-s,-r),ye.drawImage(a,0,0),ye.restore()}function cn(){if(!K||!V||!C)return;const e=K.clientWidth,t=K.clientHeight;if(e===0||t===0)return;(V.width!==e||V.height!==t)&&(V.width=e,V.height=t,C.width=e,C.height=t);const o=ge(),n=Z();if(o&&(!n.initialSetupDone||rr())){const i=o.width/o.height,s=e/t,r=i>s?e/o.width:t/o.height,l=(e-o.width*r)/2,u=(t-o.height*r)/2;wt({scale:r,offsetX:l,offsetY:u,initialSetupDone:!0}),Rr(!1)}A()}function Hs(e){if(e.length!==4)return null;const t=e.map(r=>r.x+r.y),o=e[t.indexOf(Math.min(...t))],n=e[t.indexOf(Math.max(...t))],a=e.map(r=>r.y-r.x),i=e[a.indexOf(Math.min(...a))],s=e[a.indexOf(Math.max(...a))];return{tl:o,tr:i,bl:s,br:n}}function Pl(e,t,o){const n=Hs(e);if(!n)return[];const{tl:a,tr:i,bl:s,br:r}=n,l=[];for(let u=0;u<t;u++){const g=t>1?u/(t-1):0,c=a.x+(s.x-a.x)*g,m=a.y+(s.y-a.y)*g,f=i.x+(r.x-i.x)*g,p=i.y+(r.y-i.y)*g;for(let y=0;y<o;y++){const h=o>1?y/(o-1):0,x=c+(f-c)*h,E=m+(p-m)*h;l.push({x,y:E})}}return l}function Tl(e,t){const o=z();if(o!=="selectingGridCorners"&&o!=="adjustingGrid")return;const n=Ho(),a=ya();if(e.save(),e.setLineDash([6,3]),e.strokeStyle="rgba(255, 255, 255, 0.9)",e.lineWidth=1/t.scale,n.length===4){const r=Hs(n);if(r){const{tl:l,tr:u,bl:g,br:c}=r;e.beginPath(),e.moveTo(l.x,l.y),e.lineTo(u.x,u.y),e.lineTo(c.x,c.y),e.lineTo(g.x,g.y),e.closePath(),e.stroke();const m=va(),f=Pl(n,m.rows,m.cols),p=(u.x-l.x+(c.x-g.x))/2,y=(g.y-l.y+(c.y-u.y))/2,h=Math.min(p/(m.cols-1),y/(m.rows-1))/5;e.fillStyle="rgba(255, 255, 0, 0.4)",f.forEach(x=>{e.beginPath(),e.arc(x.x,x.y,h,0,2*Math.PI),e.fill()})}}else if(o==="selectingGridCorners"&&n.length>0){const r=n[n.length-1],l=Oi();l&&(e.beginPath(),e.moveTo(r.x,r.y),e.lineTo(l.x,l.y),e.stroke())}e.setLineDash([]);const i=5/t.scale,s=1+Math.sin(Date.now()/200)*.2;n.forEach((r,l)=>{const u=i*(a===l?1.8:1)*s;e.fillStyle=a===l?"rgba(255, 100, 100, 1)":"rgba(255, 255, 0, 0.9)",e.strokeStyle="rgba(0, 0, 0, 0.5)",e.lineWidth=1/t.scale,e.beginPath(),e.arc(r.x,r.y,u,0,2*Math.PI),e.fill(),e.stroke()}),e.restore()}function A(){if(!Y||!v){log("canvasManager","error","ERRO CRÍTICO: Tentativa de desenhar, mas os contextos do canvas não estão inicializados.");return}const e=ge(),t=Z();if(!e){Y.fillStyle="#f0f0f0",Y.fillRect(0,0,V.width,V.height),v.clearRect(0,0,C.width,C.height);return}Y.fillStyle=ba()?"#111827":"#f0f0f0",Y.fillRect(0,0,V.width,V.height),v.clearRect(0,0,C.width,C.height),Y.save(),Y.translate(t.offsetX,t.offsetY),Y.scale(t.scale,t.scale),Y.drawImage(e,0,0),Y.restore(),Lt&&(v.save(),v.fillStyle="rgba(0, 100, 255, 0.2)",v.strokeStyle="rgba(0, 100, 255, 0.7)",v.lineWidth=1,v.fillRect(N.x,N.y,N.width,N.height),v.strokeRect(N.x,N.y,N.width,N.height),v.restore()),v.save(),v.translate(t.offsetX,t.offsetY),v.scale(t.scale,t.scale),Tl(v,t);const o=$(),n=b().filter(i=>i.isSample).sort((i,s)=>i.id-s.id);b().forEach(i=>{v.save();let s=ROI_STROKE_STYLE,r=ROI_LINE_WIDTH/t.scale;i.id===w()&&(s=ROI_ANALYTICAL_WHITE_STROKE_STYLE),i.isSample&&(s=ROI_SAMPLE_STROKE_STYLE);const l=o.has(i.id);l&&(s=ROI_SELECTED_STROKE_STYLE,r=(ROI_LINE_WIDTH+1.5)/t.scale),v.fillStyle="rgba(0,0,0,0.001)",v.strokeStyle=s,v.lineWidth=r;const u=z()==="sequencingRois";let g=!1,c=-1;if(u?(c=nn().indexOf(i.id),g=c!==-1,!i.isSample&&i.id!==w()?g?v.fillStyle="rgba(22, 163, 74, 0.4)":v.fillStyle="rgba(59, 130, 246, 0.25)":v.globalAlpha=.3):J()&&(l?(v.globalAlpha=1,v.fillStyle="rgba(0, 123, 255, 0.2)"):(v.globalAlpha=.5,v.fillStyle="rgba(100, 120, 140, 0.1)")),i.type==="rect"?(v.fillRect(i.x,i.y,i.width,i.height),v.strokeRect(i.x,i.y,i.width,i.height)):i.type==="circle"&&(v.beginPath(),v.arc(i.x+i.radius,i.y+i.radius,i.radius,0,2*Math.PI),v.fill(),v.stroke()),g){const m=c+1,f=i.type==="rect"?i.x+i.width/2:i.x+i.radius,p=i.type==="rect"?i.y+i.height/2:i.y+i.radius,y=i.type==="rect"?Math.min(i.width,i.height):i.radius*2,h=Math.max(12/t.scale,y*.6);v.globalAlpha=1,v.font=`bold ${h}px Arial`,v.textAlign="center",v.textBaseline="middle",v.strokeStyle="rgba(0, 0, 0, 0.8)",v.lineWidth=h/12,v.strokeText(m,f,p),v.fillStyle="white",v.fillText(m,f,p)}else{let m=i.customName||i.name;if(i.id===w())m="⭐ BRANCO";else if(i.isSample){const f=n.findIndex(p=>p.id===i.id);m=`🧪 Amostra ${f!==-1?f+1:""}`,i.customName&&(m+=` (${i.customName})`)}if(m){const f=Math.max(8,12/t.scale);v.font=`bold ${f}px Arial`,v.fillStyle=s,v.textAlign="center",v.textBaseline="bottom",v.shadowColor="rgba(0, 0, 0, 0.9)",v.shadowBlur=2/t.scale,v.shadowOffsetX=1/t.scale,v.shadowOffsetY=1/t.scale;const p=i.type==="rect"?i.x+i.width/2:i.x+i.radius,y=i.y-f*.3;v.fillText(m,p,y)}}o.size===1&&l&&i.id===Ce()&&Nl(i),v.restore()});const a=mt();if(er()&&a&&(v.strokeStyle=ROI_SELECTED_STROKE_STYLE,v.lineWidth=ROI_LINE_WIDTH/t.scale,a.type==="rect"?v.strokeRect(a.x,a.y,a.width,a.height):a.type==="circle"&&(v.beginPath(),v.arc(a.x+a.radius,a.y+a.radius,a.radius,0,2*Math.PI),v.stroke())),v.restore(),Be){const i=fi()&&Yt();Be.classList.toggle("hidden",!i)}fi()&&Yt()&&$l(Oi())}function Dl(){const e=ge();if(!e)return;const t=e.height;Ur(t);const o=e.width,n=e.height,a=document.createElement("canvas"),i=a.getContext("2d");a.width=n,a.height=o,i.translate(n/2,o/2),i.rotate(90*Math.PI/180),i.drawImage(e,-o/2,-n/2),xa(a),ea()}function Ol(){wt({initialSetupDone:!1}),cn()}function Nl(e){if(!v||e.isSizeLocked)return;const t=Math.max(ROI_HANDLE_VISUAL_DIAMETER_SCREEN_PX/Z().scale,6);v.fillStyle=ROI_HANDLE_FILL_STYLE,(e.type==="rect"?_s(e):Vs(e)).forEach(n=>{e.type==="rect"?v.fillRect(n.x-t/2,n.y-t/2,t,t):(v.beginPath(),v.arc(n.x,n.y,t/2,0,2*Math.PI),v.fill())})}function _s(e){return[{x:e.x,y:e.y,type:"nw"},{x:e.x+e.width/2,y:e.y,type:"n"},{x:e.x+e.width,y:e.y,type:"ne"},{x:e.x+e.width,y:e.y+e.height/2,type:"e"},{x:e.x+e.width,y:e.y+e.height,type:"se"},{x:e.x+e.width/2,y:e.y+e.height,type:"s"},{x:e.x,y:e.y+e.height,type:"sw"},{x:e.x,y:e.y+e.height/2,type:"w"}]}function Vs(e){return[{x:e.x+e.radius,y:e.y,type:"n_radius"},{x:e.x+2*e.radius,y:e.y+e.radius,type:"e_radius"},{x:e.x+e.radius,y:e.y+2*e.radius,type:"s_radius"},{x:e.x,y:e.y+e.radius,type:"w_radius"}]}function Qe(e,t){let o=t;if(t.touches&&t.touches.length>0?o=t.touches[0]:t.changedTouches&&t.changedTouches.length>0&&(o=t.changedTouches[0]),!e||typeof o.clientX>"u")return null;const n=e.getBoundingClientRect(),a=o.clientX-n.left,i=o.clientY-n.top,s=Z(),r=(a-s.offsetX)/s.scale,l=(i-s.offsetY)/s.scale;return{x:r,y:l,dX:a,dY:i,clientX:o.clientX,clientY:o.clientY}}function ql(e,t){const o=b();for(let n=o.length-1;n>=0;n--)if(ol(e,t,o[n]))return o[n];return null}function Fl(e,t,o){if(e.isSizeLocked||J())return null;const n=ROI_HANDLE_TOUCH_RADIUS_SCREEN_PX/Z().scale,a=e.type==="rect"?_s(e):Vs(e);for(const i of a)if(Math.hypot(t-i.x,o-i.y)<n)return i;return null}function Gs(e){if(!e)return-1;const t=Ho(),o=15/Z().scale;for(let n=0;n<t.length;n++)if(Math.hypot(e.x-t[n].x,e.y-t[n].y)<o)return n;return-1}function bi(e){if(e.touches&&e.cancelable&&e.preventDefault(),Lt=!1,e.touches&&e.touches.length>1){G&&clearTimeout(G),da(!1,null,null);return}window.addEventListener("mousemove",ai),window.addEventListener("mouseup",ii),window.addEventListener("touchmove",Ws,{passive:!1}),window.addEventListener("touchend",Ys),j().visible&&tt();const t=Qe(C,e);if(!t)return;const o=gt();k={isActionInitiated:!1,isPanningWithSpace:k.isPanningWithSpace,startTime:Date.now(),startPos:t,clickedRoiOnStart:ql(t.x,t.y)};const n=o==="rect"||o==="circle",a=mt()||k.clickedRoiOnStart||z()==="adjustingGrid"||z()==="selectingGridCorners"||n;if(Yt()&&a&&(Ui(!0),A()),z()==="adjustingGrid"){const s=Gs(t);s!==-1&&Yi(s);return}o!=="pointer"?(Ra(!1),Ie(),da(!0,t,{type:o,x:t.x,y:t.y,width:0,height:0,radius:0}),k.isActionInitiated=!0):G=setTimeout(()=>{zl(),G=null},Al)}function ai(e){e.touches&&e.touches.length===1&&e.cancelable&&e.preventDefault();const t=Qe(C,e);if(!t)return;ua(t);const o=z(),n=ya();if(o==="adjustingGrid"){const a=Gs(t);C.style.cursor=a!==-1||n!==-1?"move":"grab"}if(n!==-1){br(n,t),A();return}if(tn()){if(!k.isActionInitiated&&k.startPos&&Math.hypot(t.dX-k.startPos.dX,t.dY-k.startPos.dY)>5){k.isActionInitiated=!0,G&&(clearTimeout(G),G=null);const{clickedRoiOnStart:i,startPos:s}=k;if(i){const r=i.id===Ce()?Fl(i,s.x,s.y):null;if(r)console.log(`[CANVASMANAGER] Iniciando redimensionamento da ROI ${i.id}.`),gr(!0,r.type,s);else{console.log(`[CANVASMANAGER] Iniciando movimento da ROI ${i.id}.`),$().has(i.id)||(Ie(),Ke(i.id));const l=Array.from($()).map(u=>{const g=b().find(c=>c.id===u);return g?{id:g.id,x:g.x,y:g.y}:null}).filter(Boolean);ur(!0),dr({mousePos:s,roiPositions:l})}}else(!on()||k.isPanningWithSpace)&&yn(!0,{x:t.clientX,y:t.clientY})}if(k.isPanningWithSpace&&yn(!0,{x:t.clientX,y:t.clientY}),Lt)N.width=t.dX-N.x,N.height=t.dY-N.y;else if(mt())Vr(t.x,t.y);else if(Ai())Gr(t.x,t.y);else if(ki())Yr(t.x,t.y);else if(wi()){const a=Z();wt({offsetX:a.offsetX+(t.clientX-mi().x),offsetY:a.offsetY+(t.clientY-mi().y)}),yn(!0,{x:t.clientX,y:t.clientY})}A()}}function ii(e){window.removeEventListener("mousemove",ai),window.removeEventListener("mouseup",ii),window.removeEventListener("touchmove",Ws),window.removeEventListener("touchend",Ys);const t=!G;G&&(clearTimeout(G),G=null),ya()!==-1&&(Yi(-1),A());const o=Qe(C,e);let n=!1;const a=Ai(),i=ki(),s=wi(),r=!k.isActionInitiated&&!t;if(z()==="selectingGridCorners"&&!s&&o)log("canvasManager","info",`Adicionando ponto de canto da grade em (${o.x.toFixed(1)}, ${o.y.toFixed(1)}).`),Ml(o),Bl(),n=!0;else if(r){const l=k.clickedRoiOnStart;z()==="sequencingRois"?l&&xl(l.id):J()?l&&(qi(l.id),n=!0):(l?($().has(l.id)&&$().size===1?Ce()===l.id?(xn(null),log("canvasManager","info",`ROI ${l.id} saiu do Modo de Edição.`)):l.isSizeLocked?log("canvasManager","info",`Entrada no Modo de Edição bloqueada para ROI ${l.id} pois seu tamanho está travado.`):(xn(l.id),log("canvasManager","info",`ROI ${l.id} entrou no Modo de Edição.`)):(Ie(),Ke(l.id),log("canvasManager","info",`ROI ${l.id} selecionada.`)),e.pointerType!=="touch"&&o&&Cr(l.id,o.clientX,o.clientY)):(Ce()&&log("canvasManager","info",`ROI ${Ce()} saiu do Modo de Edição.`),Ie()),n=!0)}else Lt?(log("canvasManager","info","Finalizando seleção por região (Marquee)."),Gl(N,J()),n=!0,Lt=!1):mt()?Hr(mt()):(a||i)&&zr();Ui(!1),Ca(),k={},n&&oa(),A()}function zl(){triggerVibration(50),k.isActionInitiated=!0;const{clickedRoiOnStart:e,startPos:t}=k;e&&gt()==="pointer"?(log("canvasManager","info","Iniciando multisseleção por toque longo."),Ra(!0),xn(null),$().has(e.id)||Ke(e.id),oa(),na()):!e&&gt()==="pointer"&&(log("canvasManager","info","Iniciando seleção por região (Marquee) por toque longo."),Lt=!0,N={x:t.dX,y:t.dY,width:0,height:0}),A()}function Hl(e){e.key===" "&&(k.isPanningWithSpace=!1,gt()==="pointer"&&(C.style.cursor="grab"))}function _l(e){if(typeof e.key=="string"){if(e.key===" "&&!k.isPanningWithSpace&&(k.isPanningWithSpace=!0,C.style.cursor="grabbing"),e.key==="Delete"||e.key==="Backspace"){if(document.activeElement.tagName==="INPUT"||document.activeElement.tagName==="TEXTAREA")return;$().size>0&&ks()}if(e.key.toLowerCase()==="m"){if(document.activeElement.tagName==="INPUT"||document.activeElement.tagName==="TEXTAREA")return;e.preventDefault(),Xi(),kt()}}}function Vl(e){if(on()||(e.preventDefault(),!tn()))return;const t=Qe(C,e),o=Z(),n=o.scale,a=.1,i=e.deltaY<0?n*(1+a):n/(1+a),s=Math.max(.05,Math.min(i,20)),r=t.dX-(t.dX-o.offsetX)*(s/n),l=t.dY-(t.dY-o.offsetY)*(s/n);wt({scale:s,offsetX:r,offsetY:l}),A()}function Gl(e,t){const o={x:Math.min(e.x,e.x+e.width),y:Math.min(e.y,e.y+e.height),width:Math.abs(e.width),height:Math.abs(e.height)};t||Ie();const n=Z();b().forEach(a=>{const i=(a.type==="rect"?a.x+a.width/2:a.x+a.radius)*n.scale+n.offsetX,s=(a.type==="rect"?a.y+a.height/2:a.y+a.radius)*n.scale+n.offsetY;i>=o.x&&i<=o.x+o.width&&s>=o.y&&s<=o.y+o.height&&Ke(a.id)})}function Wl(e,t){const o=C.getBoundingClientRect(),n=(e.clientX+t.clientX)/2,a=(e.clientY+t.clientY)/2;return{x:n-o.left,y:a-o.top}}function Yl(e,t){return Math.hypot(e.clientX-t.clientX,e.clientY-t.clientY)}function Ws(e){if(e.touches&&e.cancelable&&e.preventDefault(),e.touches.length===1)ai(e);else if(e.touches.length===2&&!on()){const t=Yl(e.touches[0],e.touches[1]),o=Wl(e.touches[0],e.touches[1]);if(Pt===null){Pt=t;return}const n=Z(),a=t/Pt,i=Math.max(.05,Math.min(n.scale*a,20)),s=o.x-(o.x-n.offsetX)*(i/n.scale),r=o.y-(o.y-n.offsetY)*(i/n.scale);wt({scale:i,offsetX:s,offsetY:r}),Pt=t,A()}}function Ys(e){if(Pt=null,e.touches.length===1){Ca();const t=Qe(C,e.touches[0]);t&&(da(!0,t,null),yn(!0,{x:t.clientX,y:t.clientY}))}else e.touches.length===0&&ii(e)}function Ul(){if(log("canvasManager","info",">>> initializeCanvas INICIADA"),V&&(Y=V.getContext("2d")),C&&(v=C.getContext("2d",{willReadFrequently:!0})),qe&&(ye=qe.getContext("2d")),!Y||!v){log("canvasManager","error","Falha crítica: Não foi possível obter os contextos de renderização do canvas.");return}C&&(C.addEventListener("mousedown",bi),C.addEventListener("touchstart",bi,{passive:!1}),C.addEventListener("mouseleave",()=>{G&&clearTimeout(G)}),C.addEventListener("mouseenter",e=>{ua(Qe(C,e))}),C.addEventListener("mousemove",e=>{const t=Qe(C,e);t&&(ua(t),z()==="selectingGridCorners"&&A())}),C.addEventListener("wheel",Vl,{passive:!1}),window.addEventListener("keydown",_l),window.addEventListener("keyup",Hl),la||(la=new ResizeObserver(()=>cn()),la.observe(K))),log("canvasManager","success",">>> initializeCanvas CONCLUÍDA - Contextos definidos.")}const Me=new Map;for(const e in analyticalEquationsBySystem){const t=analyticalEquationsBySystem[e];for(const o in t)t[o].forEach(a=>{const i=`SA (${e} - ${a.text})`;Me.set(i,a)})}function Xl(){return{border:{top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},centerAlign:{vertical:"middle",horizontal:"center"},tableTitleStyle:{font:{bold:!0,size:12}},groupHeaderStyle:{font:{bold:!0,color:{argb:"FFFFFFFF"}},fill:{type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}},alignment:{vertical:"middle",horizontal:"center"},border:{top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}}},subHeaderStyle:{font:{bold:!0},fill:{type:"pattern",pattern:"solid",fgColor:{argb:"FFE0E0E0"}},alignment:{vertical:"middle",horizontal:"center"},border:{top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}}},dataCellStyle:{border:{top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}}},bandedDataCellStyle:{border:{top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},fill:{type:"pattern",pattern:"solid",fgColor:{argb:"FFF2F2F2"}}}}}function jl(e,t){const o=e.addWorksheet("Relatório de Análise"),n=(l,u)=>{const g=o.addRow(l);return g.eachCell({includeEmpty:!0},c=>{c.style=u}),g};let a=o.addRow(["Tabela 1: Concentrações Estimadas para Amostras"]);a.font=t.tableTitleStyle.font,o.addRow([]);const i=b().filter(l=>l.isSample),s=D();if(i.length>0&&s.length>0){const l=[...new Set(s.flatMap(g=>g.models.map(c=>g.parameter)))].sort(),u=l.map(g=>{var c;return((c=Me.get(g))==null?void 0:c.fullName)||g});n([`Nome da Amostra / Parâmetro (${Q()})`,...u],t.subHeaderStyle),i.forEach(g=>{const c=new Map(g.predictedConcentrations.map(f=>[f.parameter,f.concentration])),m=[g.customName||g.name,...l.map(f=>c.has(f)?Number(c.get(f)):"-")];n(m,t.dataCellStyle)})}else o.addRow(["Nenhuma amostra ou curva analítica disponível para gerar previsões."]);o.addRow([]),a=o.addRow(["Tabela 2: Modelos de Curva Analítica Gerados"]),a.font=t.tableTitleStyle.font,n(["Parâmetro (Nome Completo)","Tipo de Modelo","Equação","Coeficiente de Correlação (R²)"],t.subHeaderStyle),s.length>0?s.forEach(l=>{const u=Me.get(l.parameter),g=u?u.fullName:l.parameter;l.models.forEach(c=>{let m="N/A";if(c.type==="linear"&&c.coefficients){const{m:p,b:y}=c.coefficients;m=`y = ${Number(p).toFixed(5)}x + ${Number(y).toFixed(5)}`}else if(c.type==="polynomial"&&c.coefficients){const{a:p,b:y,c:h}=c.coefficients;m=`y = ${Number(p).toFixed(5)}x² + ${Number(y).toFixed(5)}x + ${Number(h).toFixed(5)}`}const f=c.type.charAt(0).toUpperCase()+c.type.slice(1);n([g,f,m,Number(c.r2)],t.dataCellStyle)})}):n(["Nenhuma curva analítica gerada."],t.dataCellStyle),o.addRow([]),a=o.addRow(["Tabela 3: Pontos Utilizados na Curva Analítica"]),a.font=t.tableTitleStyle.font;const r=b().filter(l=>l.useInCalibration&&l.concentration!==null);s.length>0&&r.length>0?s.forEach(l=>{const u=Me.get(l.parameter),g=u?u.fullName:l.parameter;o.addRow([]),n([`Dados da Curva Analítica para: ${g}`],{font:t.tableTitleStyle.font}),n([`Concentração (${Q()})`,"Sinal Analítico (SA)","Nome da ROI Padrão"],t.subHeaderStyle),r.forEach(c=>{const m=c.analyticalResponse.find(f=>f.channel===l.parameter);m&&n([Number(c.concentration),Number(m.value),c.customName||c.name],t.dataCellStyle)})}):o.addRow(["Não há dados de calibração para detalhar."]),o.columns.forEach(l=>{let u=0;l.eachCell({includeEmpty:!0},g=>{const c=g.value?g.value.toString().length:0;c>u&&(u=c)}),l.width=u<12?12:u+4})}function Ql(e,t){const o=e.addWorksheet("Dados Consolidados"),n=[...b()].sort((c,m)=>{const f=c.id===w()?0:c.isSample?2:1,p=m.id===w()?0:m.isSample?2:1;return f!==p?f-p:(c.calibrationOrder||c.id)-(m.calibrationOrder||m.id)}),a=["RGB","CIELAB","HSV","HSL","YCbCr","CMYK","HunterLab","XYZ","Sintéticos (Inter-sistema)"],i=[...new Set(b().flatMap(c=>c.analyticalResponse.map(m=>m.channel)))].sort((c,m)=>{const f=h=>h.substring(h.indexOf("(")+1,h.indexOf(" - ")),p=a.indexOf(f(c)),y=a.indexOf(f(m));return p!==y?p-y:c.localeCompare(m)}),s=i.map(c=>{var m;return((m=Me.get(c))==null?void 0:m.fullName)||c}),r=[{name:"Informações da ROI",count:11},{name:"Sistema RGB",count:6},{name:"Sistema HSV",count:3},{name:"Sistema HSL",count:3},{name:"Sistema CIELAB",count:3},{name:"Sistema YCbCr",count:3},{name:"Sistema CMYK",count:4},{name:"Sistema CIE-XYZ",count:3},{name:"Sistema HunterLab",count:3}],l=i.reduce((c,m)=>{const f=m.substring(m.indexOf("(")+1,m.indexOf(" - "));return c[f]||(c[f]=[]),c[f].push(m),c},{});a.forEach(c=>{l[c]&&r.push({name:`Respostas Analíticas - ${c}`,count:l[c].length})}),o.addRow(r.flatMap(c=>[c.name,...Array(c.count-1).fill(null)])).eachCell({includeEmpty:!0},c=>{c.style=t.groupHeaderStyle}),r.reduce((c,m)=>(m.count>1&&o.mergeCells(1,c,1,c+m.count-1),c+m.count),1);const g=["Tipo de ROI","ID","Nome","Concentração","Pixels","Coord X","Coord Y","Largura","Altura/Raio","É Amostra?","É Branco?","R Média","G Média","B Média","DP R","DP G","DP B","HSV H","HSV S","HSV V","HSL H","HSL S","HSL L","CIELAB L*","CIELAB a*","CIELAB b*","YCbCr Y","YCbCr Cb","YCbCr Cr","CMYK C","CMYK M","CMYK Y","CMYK K","XYZ X","XYZ Y","XYZ Z","Hunter L","Hunter a","Hunter b",...s];o.addRow(g).eachCell(c=>c.style=t.subHeaderStyle),n.forEach((c,m)=>{var h,x,E,I,M,S,B,P,L,_,Ee,pe,te,ne,et,dn,At,Se,X,he,un,gn,ri,li,ci,di,ui,gi;const f=oe=>oe.id===w()?"Branco":oe.isSample?"Amostra":"Ponto da Curva",p=new Map(c.analyticalResponse.map(oe=>[oe.channel,oe.value])),y=[f(c),c.id,c.customName||c.name,cleanVal(c.concentration),c.pixelCount,cleanVal(c.x),cleanVal(c.y),c.type==="rect"?cleanVal(c.width):"",c.type==="rect"?cleanVal(c.height):cleanVal(c.radius),c.isSample?"Sim":"Não",c.id===w()?"Sim":"Não",cleanVal((h=c.rgb)==null?void 0:h.avgR),cleanVal((x=c.rgb)==null?void 0:x.avgG),cleanVal((E=c.rgb)==null?void 0:E.avgB),cleanVal((I=c.rgb_stdDev)==null?void 0:I.r),cleanVal((M=c.rgb_stdDev)==null?void 0:M.g),cleanVal((S=c.rgb_stdDev)==null?void 0:S.b),cleanVal((B=c.hsv)==null?void 0:B.h),cleanVal((P=c.hsv)==null?void 0:P.s),cleanVal((L=c.hsv)==null?void 0:L.v),cleanVal((_=c.hsl)==null?void 0:_.h),cleanVal((Ee=c.hsl)==null?void 0:Ee.s),cleanVal((pe=c.hsl)==null?void 0:pe.l),cleanVal((te=c.lab)==null?void 0:te.l),cleanVal((ne=c.lab)==null?void 0:ne.a),cleanVal((et=c.lab)==null?void 0:et.b),cleanVal((dn=c.ycbcr)==null?void 0:dn.y),cleanVal((At=c.ycbcr)==null?void 0:At.cb),cleanVal((Se=c.ycbcr)==null?void 0:Se.cr),cleanVal((X=c.cmyk)==null?void 0:X.c),cleanVal((he=c.cmyk)==null?void 0:he.m),cleanVal((un=c.cmyk)==null?void 0:un.y),cleanVal((gn=c.cmyk)==null?void 0:gn.k),cleanVal((ri=c.xyz)==null?void 0:ri.x),cleanVal((li=c.xyz)==null?void 0:li.y),cleanVal((ci=c.xyz)==null?void 0:ci.z),cleanVal((di=c.hunterLab)==null?void 0:di.l),cleanVal((ui=c.hunterLab)==null?void 0:ui.a),cleanVal((gi=c.hunterLab)==null?void 0:gi.b),...i.map(oe=>p.has(oe)?cleanVal(p.get(oe)):"")];o.addRow(y).eachCell({includeEmpty:!0},oe=>oe.style=m%2===0?t.bandedDataCellStyle:t.dataCellStyle)}),o.columns.forEach(c=>{let m=0;c.eachCell({includeEmpty:!0},f=>{m=Math.max(m,f.value?f.value.toString().length:10)}),c.width=m<10?10:m+4})}function Kl(e,t,o,n,a){const i=e.internal.pageSize.getWidth(),s=e.internal.pageSize.getHeight(),r=15;e.setFontSize(10),e.setFont("helvetica","normal");const l=(u,g,c)=>{if(u)try{let p=u.width,y=u.height,h=p/y;p>35&&(p=35,y=p/h),y>20&&(y=20,p=y*h),e.addImage(u.data,"JPEG",g,c,p,y)}catch(m){log("exportManager","error","Erro ao adicionar logo ao PDF:",m)}};l(n.lab,r,8),l(n.institution,i-r-35,8),e.setFont("helvetica","bold"),e.text(o.labName||"",i/2,15,{align:"center"}),e.setFont("helvetica","normal"),e.text(o.institutionName||"",i/2,22,{align:"center"}),e.setLineWidth(.5),e.line(r,30,i-r,30),e.setFontSize(8),e.text(`Página ${t.pageNumber} de ${e.internal.getNumberOfPages()}`,i/2,s-10,{align:"center"}),e.text(`Gerado em: ${a}`,i-r,s-10,{align:"right"}),e.text([o.analystName,o.contactEmail,o.contactPhone].filter(Boolean).map(u=>u.trim()).join(" | "),r,s-10)}function pn(e,t,o,n,a){return t+o>e.internal.pageSize.getHeight()-25&&(e.addPage(),t=40),e.setFontSize(12),e.setFont("helvetica","bold"),e.text(`${a}. ${n}`,15,t),t+7}async function Jl(){log("exportManager","info","Iniciando exportação para Excel.");try{if(b().length===0){log("exportManager","warn","Exportação para Excel cancelada: não há ROIs."),R("Não há dados para exportar. Crie ao menos uma ROI.");return}const e=new ExcelJS.Workbook,t=Xl();jl(e,t),Ql(e,t);const o=await e.xlsx.writeBuffer(),n=new Blob([o],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),a=document.createElement("a");a.href=URL.createObjectURL(n),a.download=`Relatorio_Analise_${new Date().toLocaleString("sv").replace(/ /g,"_").replace(/:/g,"")}.xlsx`,a.click(),URL.revokeObjectURL(a.href),log("exportManager","info","Relatório Excel gerado e download iniciado com sucesso."),R("Relatório Excel formatado exportado com sucesso!")}catch(e){log("exportManager","error","Erro ao exportar para Excel:",e),R(`Ocorreu um erro ao gerar o arquivo Excel: ${e.message}`)}}async function Zl(e){const t=Ge();if(!t||D().length===0){log("exportManager","warn","Geração de PDF cancelada: a curva analítica não foi gerada."),R("Gere uma curva analítica antes de exportar o relatório PDF.");return}log("exportManager","info","Iniciando geração de relatório PDF.",e),Ze("Gerando relatório PDF, por favor aguarde...");try{const{jsPDF:o}=window.jspdf,n=new o("p","mm","a4"),a=15,i=n.internal.pageSize.getWidth()-2*a;let s=40,r=1;const l=JSON.parse(localStorage.getItem("reportSettings"))||{},u=await xi(l.labLogo),g=await xi(l.institutionLogo),c=new Date().toLocaleString("pt-BR"),m=S=>Kl(n,S,l,{lab:u,institution:g},c);n.setFontSize(18),n.setFont("helvetica","bold"),n.text("Relatório de Análise Colorimétrica Digital",n.internal.pageSize.getWidth()/2,s,{align:"center"}),s+=7;const f=We();f&&(n.setFont("helvetica","normal"),n.setFontSize(14),n.setTextColor(100),n.text(f,n.internal.pageSize.getWidth()/2,s,{align:"center"}),s+=10),s=pn(n,s,20,"Detalhes da Análise",r++),n.autoTable({startY:s,body:[["Amostra/Lote:",e.sampleId],["Cód. Relatório:",e.reportId],["Local:",e.analysisLocation],["Projeto:",e.applicationArea]].filter(S=>S[1]),theme:"plain",styles:{fontSize:10,cellPadding:1},columnStyles:{0:{fontStyle:"bold",cellWidth:40}}}),s=n.autoTable.previous.finalY+10;const p=e.includeImage?await oc():null;if(p){const S=n.getImageProperties(p),B=S.height*i/S.width;s=pn(n,s,B+5,"Imagem da Análise com ROIs",r++),n.addImage(p,"JPEG",a,s,i,B),s+=B+10}const y=t.options.plugins.customCanvasBackgroundColor.color;t.options.plugins.customCanvasBackgroundColor.color="white",t.update("none");const h=t.toBase64Image("image/jpeg",.9);t.options.plugins.customCanvasBackgroundColor.color=y,t.update("none");const x=t.height*i/t.width;s=pn(n,s,x+30,"Curva Analítica e Modelos",r++),n.addImage(h,"JPEG",a,s,i,x),s+=x+5;const E=D().flatMap(S=>{const B=Me.get(S.parameter),P=B?B.fullName:S.parameter;return S.models.map(L=>{let _="N/A";if(L.type==="linear"&&L.coefficients){const{m:te,b:ne}=L.coefficients;_=`y = ${Number(te).toFixed(4)}x + ${Number(ne).toFixed(4)}`}else if(L.type==="polynomial"&&L.coefficients){const{a:te,b:ne,c:et}=L.coefficients;_=`y = ${Number(te).toFixed(4)}x² + ${Number(ne).toFixed(4)}x + ${Number(et).toFixed(4)}`}const Ee=L.r2?Number(L.r2).toFixed(5):"N/A",pe=L.type==="linear"?"Linear":"Polinomial";return[P,pe,_,Ee]})});n.autoTable({startY:s,head:[["Parâmetro","Modelo","Equação","R²"]],body:E,theme:"grid",headStyles:{fillColor:[22,110,160],textColor:255,fontStyle:"bold"},didDrawPage:m}),s=n.autoTable.previous.finalY+10,s=pn(n,s,20,"Resultados e Dados Brutos",r++);const I=b().filter(S=>S.isSample);if(I.length>0){n.setFontSize(10),n.setFont("helvetica","normal"),n.text("Tabela de Previsão de Concentração para Amostras:",a,s),s+=5;const S=I.flatMap(B=>B.predictedConcentrations.length?B.predictedConcentrations.map(P=>{const L=Me.get(P.parameter),_=L?L.fullName:P.parameter;return[B.customName||B.name,_,P.concentration.toFixed(4),P.r2.toFixed(5)]}):[[B.customName||B.name,"N/A","Nenhuma curva gerada","N/A"]]);n.autoTable({startY:s,head:[["Amostra","Parâmetro Utilizado",`Concentração Prevista (${Q()})`,"R² do Modelo"]],body:S,theme:"grid",headStyles:{fillColor:[22,110,160],textColor:255,fontStyle:"bold"},didDrawPage:m}),s=n.autoTable.previous.finalY+10}const M=b().filter(S=>S.useInCalibration&&S.concentration!==null);if(M.length>0&&D().length>0){n.setFontSize(10),n.setFont("helvetica","normal"),n.text("Tabela de Dados Utilizados na Calibração:",a,s),s+=5;const S=M.flatMap(P=>D().map(L=>{const _=Me.get(L.parameter),Ee=_?_.fullName:L.parameter,pe=P.analyticalResponse.find(ne=>ne.channel===L.parameter),te=pe?pe.value.toFixed(4):"N/D";return[P.customName||P.name,P.concentration,Ee,te]})),B=[["ROI Padrão",`Conc. (${Q()})`,"Parâmetro Analisado","Sinal Analítico (SA)"]];n.autoTable({startY:s,head:B,body:S,theme:"grid",headStyles:{fillColor:[22,110,160],textColor:255,fontStyle:"bold"},didDrawPage:m})}for(let S=1;S<=n.internal.getNumberOfPages();S++)n.setPage(S),m({pageNumber:S,pageCount:n.internal.getNumberOfPages()});n.save(`Relatorio_Analise_${e.sampleId.replace(/[^a-z0-9]/gi,"_")}_${new Date().toLocaleString("sv").replace(/ /g,"_").replace(/:/g,"")}.pdf`),log("exportManager","info","Relatório PDF gerado e salvo com sucesso."),R("Relatório PDF gerado com sucesso!")}catch(o){log("exportManager","error","Erro ao gerar PDF: ",o),R("Ocorreu um erro inesperado ao gerar o relatório PDF: "+o.message)}}function ec(){Ro&&Ro.addEventListener("click",nc),Eo&&Eo.addEventListener("click",Do),So&&So.addEventListener("click",Do)}function tc(){je&&(je.dataset.visible="true"),ut.classList.add("hidden")}function Do(){je&&(je.dataset.visible="false")}function nc(){const e=Fa.value.trim();if(!e){ut.textContent='O campo "Identificação da Amostra" é obrigatório.',ut.classList.remove("hidden");return}ut.classList.add("hidden");const t={sampleId:e,reportId:za.value,analysisLocation:Ha.value,applicationArea:_a.value,includeImage:Va.checked};Do(),Zl(t)}async function oc(){const e=$i();if(!e||!e.src)return null;const t=await new Promise((r,l)=>{const u=new Image;u.onload=()=>r(u),u.onerror=g=>{log("exportManager","error","Falha ao carregar a imagem para o PDF.",g),l(new Error("Falha ao carregar a imagem para o PDF."))},u.src=e.src}),o=Math.min(1,1200/t.naturalWidth),n=t.naturalWidth*o,a=t.naturalHeight*o,i=document.createElement("canvas");i.width=n,i.height=a;const s=i.getContext("2d");return s.fillStyle="#FFFFFF",s.fillRect(0,0,n,a),s.drawImage(t,0,0,n,a),b().forEach(r=>{const l={x:r.x*o,y:r.y*o,width:r.width*o,height:r.height*o,radius:r.radius*o,type:r.type},u=Math.max(1,n*.0025),g=Math.max(8,n*.015);let c=r.isSample?"rgba(245, 158, 11, 0.9)":r.id===w()?"rgba(22, 163, 74, 0.9)":"rgba(255, 0, 0, 0.9)";Object.assign(s,{strokeStyle:c,lineWidth:u,fillStyle:c,font:`bold ${g}px Arial`,textAlign:"center",textBaseline:"bottom"}),r.type==="rect"?s.strokeRect(l.x,l.y,l.width,l.height):r.type==="circle"&&(s.beginPath(),s.arc(l.x+l.radius,l.y+l.radius,l.radius,0,2*Math.PI),s.stroke());const m=l.x+(l.type==="rect"?l.width/2:l.radius),f=l.y-g*.4;s.fillText(r.customName||r.name,m,f)}),i.toDataURL("image/jpeg",.9)}async function xi(e){return!e||!e.startsWith("data:image")?null:new Promise(t=>{const o=new Image;o.onload=()=>{const n=document.createElement("canvas"),a=n.getContext("2d");n.width=o.width,n.height=o.height,a.fillStyle="#FFFFFF",a.fillRect(0,0,n.width,n.height),a.drawImage(o,0,0),t({data:n.toDataURL("image/jpeg",.9),width:o.width,height:o.height})},o.onerror=()=>t(null),o.src=e})}let ce={};function ac(e){return new Promise((t,o)=>{const n=new FileReader;n.readAsDataURL(e),n.onload=()=>t(n.result),n.onerror=a=>o(a)})}async function Ii(e,t,o){const n=e.target.files[0];if(n){if(n.size>2*1024*1024){log("userProfile","warn",`Upload de logo cancelado: arquivo muito grande (${n.size} bytes).`),R("O arquivo de imagem é muito grande. Por favor, escolha um arquivo menor que 2MB.");return}log("userProfile","info",`Processando upload de logo para: ${o}`);try{const a=await ac(n),i=document.getElementById(t);i.innerHTML=`<img src="${a}" alt="Pré-visualização do Logo">`;const s=JSON.parse(localStorage.getItem("reportSettings"))||{};s[o]=a,localStorage.setItem("reportSettings",JSON.stringify(s)),ce[o]=a,log("userProfile","info",`Logo ${o} atualizado e salvo no cache local.`)}catch(a){log("userProfile","error","Erro ao processar o upload do logo:",a),R("Ocorreu um erro ao carregar a imagem.")}}}function Us(){try{const e=JSON.parse(localStorage.getItem("reportSettings"));e?(log("userProfile","info","Carregando perfil de usuário do localStorage."),Wo.value=e.analystName||"",Yo.value=e.operatorRole||"",Uo.value=e.labName||"",Xo.value=e.institutionName||"",jo.value=e.contactEmail||"",Qo.value=e.contactPhone||"",e.labLogo?Mt.innerHTML=`<img src="${e.labLogo}" alt="Pré-visualização do Logo do Laboratório">`:Mt.innerHTML="<span>Pré-visualização</span>",e.institutionLogo?Bt.innerHTML=`<img src="${e.institutionLogo}" alt="Pré-visualização do Logo da Instituição">`:Bt.innerHTML="<span>Pré-visualização</span>",ce=e):log("userProfile","info","Nenhum perfil de usuário encontrado no localStorage.")}catch(e){log("userProfile","error","Erro ao carregar perfil do localStorage:",e),ce={}}}function ic(){log("userProfile","info","Salvando configurações do perfil e fechando o modal.");const e={analystName:Wo.value,operatorRole:Yo.value,labName:Uo.value,institutionName:Xo.value,contactEmail:jo.value,contactPhone:Qo.value,labLogo:ce.labLogo||null,institutionLogo:ce.institutionLogo||null};localStorage.setItem("reportSettings",JSON.stringify(e)),ce=e,Oo(!0)}function sc(){log("userProfile","info","Abrindo modal de configurações do perfil."),Us(),Xe&&(Xe.dataset.visible="true")}function Oo(e=!1){Xe&&(Xe.dataset.visible="false",e||(log("userProfile","info","Modal de configurações fechado sem salvar. Revertendo alterações não salvas."),ce.labLogo?Mt.innerHTML=`<img src="${ce.labLogo}" alt="Pré-visualização do Logo do Laboratório">`:Mt.innerHTML="<span>Pré-visualização</span>",ce.institutionLogo?Bt.innerHTML=`<img src="${ce.institutionLogo}" alt="Pré-visualização do Logo da Instituição">`:Bt.innerHTML="<span>Pré-visualização</span>"))}function rc(){ho&&ho.addEventListener("click",sc),bo&&bo.addEventListener("click",ic),vo&&vo.addEventListener("click",()=>Oo(!1)),yo&&yo.addEventListener("click",()=>Oo(!1)),xo&&xo.addEventListener("change",e=>Ii(e,"labLogoPreview","labLogo")),Io&&Io.addEventListener("change",e=>Ii(e,"institutionLogoPreview","institutionLogo")),Us()}async function Xs(e){if(!e)return{success:!1,message:"Nenhum arquivo selecionado."};if(!e.type.startsWith("image/"))return{success:!1,message:"O arquivo selecionado não é uma imagem válida."};const t=new FileReader;return new Promise(o=>{t.onload=n=>{const a=new Image;a.onload=()=>{const i=document.createElement("canvas");i.width=a.naturalWidth,i.height=a.naturalHeight,i.getContext("2d").drawImage(a,0,0),Qi(),xa(i),Fi({src:n.target.result,fileName:e.name}),cn(),H(),hl(),o({success:!0,message:"Imagem carregada com sucesso!",fileName:e.name})},a.onerror=()=>{o({success:!1,message:"Erro ao carregar a imagem."})},a.src=n.target.result},t.onerror=()=>{o({success:!1,message:"Erro ao ler o arquivo."})},t.readAsDataURL(e)})}function lc(){log("imageLoader","info","Iniciando processo de exclusão da imagem atual."),Qi(),Fi({src:null,fileName:""}),xa(null),De&&(De.textContent="Nenhum arquivo"),Jo(),H(),log("imageLoader","success","Imagem e dados de análise foram limpos com sucesso.")}const cc="ImageAnalysisDB",dc=1,Ve="sessions";let hn;function js(){return new Promise((e,t)=>{if(hn)return e(hn);log("dbManager","info","Abrindo conexão com IndexedDB...");const o=indexedDB.open(cc,dc);o.onerror=n=>{log("dbManager","error","Erro ao abrir o IndexedDB:",n.target.error),t("Erro de banco de dados.")},o.onsuccess=n=>{log("dbManager","info","Conexão com IndexedDB estabelecida com sucesso."),hn=n.target.result,e(hn)},o.onupgradeneeded=n=>{log("dbManager","info","Atualizando estrutura do IndexedDB (onupgradeneeded).");const a=n.target.result;a.objectStoreNames.contains(Ve)||(a.createObjectStore(Ve,{keyPath:"id"}),log("dbManager","info",`Object store '${Ve}' criado.`))}})}async function uc(e){const t=await js();return new Promise((o,n)=>{const s=t.transaction([Ve],"readwrite").objectStore(Ve).put(e);s.onsuccess=()=>{log("dbManager","info","Sessão salva no IndexedDB com sucesso.",e.id),o()},s.onerror=r=>{log("dbManager","error","Erro ao salvar no IndexedDB:",r.target.error),n("Falha ao salvar a sessão no banco de dados.")}})}async function Qs(e){const t=await js();return new Promise((o,n)=>{const s=t.transaction([Ve],"readonly").objectStore(Ve).get(e);s.onsuccess=()=>{s.result?log("dbManager","info","Sessão carregada do IndexedDB com sucesso.",e):log("dbManager","warn","Nenhuma sessão encontrada no IndexedDB para o id:",e),o(s.result)},s.onerror=r=>{log("dbManager","error","Erro ao carregar do IndexedDB:",r.target.error),n("Falha ao carregar a sessão do banco de dados.")}})}const si="lastSession";async function gc(){const e=$i();if(!e||!e.src){log("sessionManager","warn","Salvamento de sessão abortado: nenhuma imagem carregada."),R("Não há imagem carregada para salvar na sessão.");return}log("sessionManager","info","Iniciando salvamento da sessão..."),Ze("Salvando sessão...");try{const o=await(await fetch(e.src)).blob(),n={id:si,image:{blob:o,fileName:e.fileName},rois:b(),nextRoiId:Fo(),analyticalWhiteRoiId:w(),analysisTitle:We(),currentConcentrationUnit:Q(),viewTransform:Z(),metricsCalculated:zo(),lastRegressions:D()};await uc(n),log("sessionManager","info","Sessão salva com sucesso!"),R("Sessão salva com sucesso!"),Ks()}catch(t){log("sessionManager","error","Erro ao salvar a sessão:",t),R(`Ocorreu um erro ao salvar: ${t.message}`)}}async function mc(){log("sessionManager","info","Iniciando carregamento da sessão salva..."),Ze("Carregando sessão...");try{const e=await Qs(si);if(!e||!e.image||!e.image.blob){log("sessionManager","warn","Nenhuma sessão válida foi encontrada para carregar."),R("Nenhuma sessão salva foi encontrada.");return}const t=new File([e.image.blob],e.image.fileName,{type:e.image.blob.type}),o=await Xs(t);if(o.success)b().push(...e.rois),(void 0)(e.nextRoiId),Ye(e.analyticalWhiteRoiId),Gi(e.analysisTitle),_i(e.currentConcentrationUnit),wt(e.viewTransform),zi(e.metricsCalculated),_o(e.lastRegressions),log("sessionManager","info","Sessão carregada e estado restaurado com sucesso."),H(),R("Sessão carregada com sucesso!");else throw new Error(o.message)}catch(e){log("sessionManager","error","Erro ao carregar a sessão:",e),R(`Ocorreu um erro ao carregar a sessão: ${e.message}`)}}async function Ks(){try{await Qs(si)?(log("sessionManager","info","Sessão salva encontrada. Botão de carregar habilitado."),le.disabled=!1,le.classList.remove("disabled:bg-gray-400")):(log("sessionManager","info","Nenhuma sessão salva encontrada."),le.disabled=!0,le.classList.add("disabled:bg-gray-400"))}catch(e){log("sessionManager","warn","Não foi possível verificar sessão salva:",e),le.disabled=!0,le.classList.add("disabled:bg-gray-400")}}let Js=null,Zs=null,No=null,qo=null,pa=!1;function fc(){if(pa)return;const e=document.getElementById("tools-panel"),t=document.getElementById("roi-tools-panel");e&&t?(Js=e,Zs=t,No=e.querySelector(".panel-content-wrapper"),qo=t.querySelector(".panel-content-wrapper"),No&&qo?(pa=!0,log("focusModeManager","info","Focus Mode Manager inicializado com sucesso.")):log("focusModeManager","error","Wrappers de conteúdo dos painéis de ferramentas não encontrados.")):log("focusModeManager","error","Painéis de ferramentas originais não encontrados no DOM.")}function pc(){if(fc(),!pa||!Pe){log("focusModeManager","error","Modo Foco não pode ser ativado: inicialização falhou ou a barra de ferramentas não foi encontrada.");return}Ir();const e=ba();log("focusModeManager","info",`Alternando Modo Foco para: ${e?"ATIVADO":"DESATIVADO"}.`),document.body.classList.toggle("focus-mode-on",e),e?(Pe.appendChild(No),Pe.appendChild(qo),Pe.classList.remove("hidden"),log("focusModeManager","dom","Conteúdo das ferramentas movido para a barra flutuante.")):(Js.appendChild(No),Zs.appendChild(qo),Pe.classList.add("hidden"),log("focusModeManager","dom","Conteúdo das ferramentas restaurado aos painéis originais.")),requestAnimationFrame(()=>{cn(),H()})}const Ei={title:"Guia: Controles da Imagem",htmlContent:`
        <div class="space-y-3 text-gray-800 text-left">
            <p>Este painel gerencia a imagem base para sua análise.</p>
            <ul class="list-disc list-inside pl-2 space-y-2 mt-2">
                <li><strong>Carregar:</strong> Abre um seletor de arquivos para carregar uma imagem (JPG, PNG, etc.) do seu dispositivo.</li>
                <li><strong>Excluir:</strong> Remove a imagem atual e todos os dados de análise associados (ROIs, curvas, etc.), permitindo que você comece do zero.</li>
                <li><strong>Girar:</strong> Gira a imagem em 90 graus no sentido horário. Útil para corrigir a orientação de fotos.</li>
                <li><strong>Restaurar:</strong> Centraliza a imagem na tela e restaura o nível de zoom para o padrão.</li>
            </ul>
        </div>
    `},Si={title:"Guia: Ferramentas e Interação",htmlContent:`
        <div class="space-y-4 text-gray-800 text-left">
            <div>
                <h4 class="font-semibold text-gray-900">Ferramentas de Desenho</h4>
                <ul class="list-disc list-inside pl-2 space-y-2 mt-2">
                    <li><strong>Ponteiro:</strong> A ferramenta principal para selecionar, mover e interagir com as ROIs. Use-a para clicar em uma ROI e ver suas propriedades ou para arrastá-la.</li>
                    <li><strong>Retângulo / Círculo:</strong> Selecione uma destas ferramentas para desenhar uma nova Região de Interesse (ROI) na imagem. Clique e arraste para definir o tamanho.</li>
                </ul>
            </div>
            <div>
                <h4 class="font-semibold text-gray-900">Detecção Automática</h4>
                <ul class="list-disc list-inside pl-2 space-y-2 mt-2">
                    <li><strong>Analisar Grade:</strong> Ideal para microplacas. Você define as dimensões (ex: 8x12) e marca os 4 cantos da placa para que o app crie e ordene todas as ROIs automaticamente.</li>
                    <li><strong>Configuração Avançada:</strong> Usa algoritmos de visão computacional (OpenCV.js) para encontrar todos os pontos circulares na imagem inteira com base em parâmetros de saturação, brilho e forma.</li>
                </ul>
            </div>
            <div>
                <h4 class="font-semibold text-gray-900">Interação no Canvas</h4>
                <ul class="list-disc list-inside pl-2 space-y-2 mt-2">
                    <li><strong>Zoom:</strong> Use a roda de rolagem (scroll) do mouse ou o gesto de pinça em telas de toque.</li>
                    <li><strong>Mover (Pan):</strong> Com a ferramenta Ponteiro, clique e arraste em uma área vazia da imagem. Em telas de toque, arraste com um dedo.</li>
                    <li><strong>Seleção Múltipla:</strong> Com a ferramenta Ponteiro, segure 'Shift' ou 'Ctrl' e clique em várias ROIs. Em telas de toque, faça um clique longo em uma ROI para iniciar o modo de multisseleção.</li>
                </ul>
            </div>
            <div>
                <h4 class="font-semibold text-gray-900">Controles do Canvas</h4>
                <ul class="list-disc list-inside pl-2 space-y-2 mt-2">
                    <li><strong>Modo Foco:</strong> Oculta os painéis laterais para maximizar a área de visualização da imagem. Ideal para desenhar e ajustar ROIs em telas pequenas.</li>
                    <li><strong>Lupa:</strong> Ativa/desativa uma lupa que aparece ao interagir com o canvas, facilitando o posicionamento preciso das ROIs.</li>
                    <li><strong>Travar Imagem:</strong> Bloqueia o zoom e o movimento (pan) da imagem, evitando deslocamentos acidentais ao trabalhar com as ROIs.</li>
                </ul>
            </div>
        </div>
    `},Ri={title:"Guia: Ações em ROIs",htmlContent:`
        <div class="space-y-3 text-gray-800 text-left">
            <p>Estas ações se aplicam às ROIs que você selecionou no canvas ou na lista.</p>
            <ul class="list-disc list-inside pl-2 space-y-2 mt-2">
                <li><strong>Definir Amostra:</strong> Marca a ROI selecionada como uma amostra de concentração desconhecida. Amostras são excluídas da calibração e usadas para previsão.</li>
                <li><strong>Definir Branco:</strong> Marca uma única ROI como o "Branco Analítico", a referência para cálculos diferenciais como Delta E e Absorbância.</li>
                <li><strong>Duplicar:</strong> Cria uma cópia da(s) ROI(s) selecionada(s).</li>
                <li><strong>Excluir:</strong> Apaga a(s) ROI(s) selecionada(s).</li>
                <li><strong>Redimensionar Seleção:</strong> Ajusta o tamanho de todas as ROIs selecionadas simultaneamente usando o slider.</li>
                <li><strong>Travar Posição / Tamanho:</strong> Bloqueia o movimento ou o redimensionamento das ROIs selecionadas para evitar alterações acidentais.</li>
                <li><strong>Ordenar ROIs:</strong> Inicia o painel de ordenação para as ROIs selecionadas, permitindo definir a sequência correta dos pontos de calibração.</li>
            </ul>
        </div>
    `},Ci={title:"Ajuda: Ordenar ROIs de Calibração",htmlContent:`
        <div class="space-y-3 text-gray-800 text-left">
            <p>Esta função permite definir a sequência numérica dos seus pontos de calibração (Padrão 1, Padrão 2, etc.), o que é crucial para construir a curva analítica corretamente.</p>
            <p><strong>Quando o botão está habilitado?</strong> O botão 'Ordenar ROIs' só fica ativo quando há pelo menos 2 ROIs que <strong>não</strong> são amostras nem o branco analítico.</p>
            <p><strong>Como usar:</strong></p>
            <ul class="list-disc list-inside pl-2 space-y-1">
                <li><strong>Ordenação Automática:</strong> Ideal para microplacas. Escolha um padrão de leitura (horizontal/vertical) e a direção para numerar as ROIs automaticamente.</li>
                <li><strong>Ordenação Manual:</strong> Clique em "ordenar por toque manual" para entrar no modo de seleção, onde você clica nas ROIs na ordem exata que desejar.</li>
                <li><strong>Ordenar Seleção:</strong> Se você selecionar um grupo específico de ROIs antes de clicar em "Ordenar ROIs", apenas as ROIs selecionadas entrarão no processo de ordenação.</li>
            </ul>
        </div>
    `};let T=null,W,ca={key:"r2",direction:"desc"};function hc(e){const{type:t,task:o,payload:n}=e.data;if(t==="success"){if(log("eventBinder","info",`[WORKER] Sucesso na tarefa: ${o}`),o==="calculateMetrics")mn(),bn(n.rois),zi(!0),Vi(!1),n.whiteNeededButMissing?R("Alguns cálculos foram pulados porque exigem um 'Branco Analítico' que não foi definido."):ue("Métricas calculadas com sucesso!"),H();else if(o==="generateRegressions"){mn();const a=n;if(a.length===0){R("Não foi possível gerar modelos de regressão para os parâmetros selecionados.");return}const i=new Set(a.map(s=>s.parameter));if(fr(i),log("eventBinder","info",`Estado de visibilidade inicializado com ${i.size} parâmetros.`),typeof CHART_STYLES>"u"||!CHART_STYLES){log("eventBinder","error","Variável global CHART_STYLES de config.js não está disponível."),R("Erro de configuração: não foi possível carregar os estilos do gráfico.");return}Po(a,CHART_STYLES),W&&(log("eventBinder","info","Regressões recebidas. Disparando previsão de concentração..."),W.postMessage({type:"predictConcentrations",payload:{rois:b(),regressions:a}})),we()}else if(o==="predictConcentrations")bn(n),fe();else if(o==="processRoiData"){const a=b().find(i=>i.id===n.roiId);if(a){const{roiId:i,...s}=n;Object.assign(a,s),fe()}}else if(o==="detectCircles"){mn();const a=ws(n),i=new Set(a);ti(i).then(()=>{log("eventBinder","info","Sequenciamento pós-detecção concluído com sucesso."),H(),ue(`${n.length} ROIs criadas e ordenadas!`)}).catch(s=>{log("eventBinder","warn","Sequenciamento pós-detecção cancelado ou falhou. Aplicando ordenação padrão.",s.message),ee(),H(),ue(`${n.length} ROIs criadas com ordenação padrão.`)})}}else t==="error"&&(log("eventBinder","error",`[WORKER] Erro na tarefa: ${o}`,n.message,n.stack),mn(),R(`Ocorreu um erro no processamento: ${n.message}`))}function yc(e){if(W){const{roisForCalibration:t,selectedParams:o}=e.detail;log("eventBinder","info","Recebido evento para gerar regressões. Enviando para o worker."),W.postMessage({type:"generateRegressions",payload:{roisForCalibration:t,selectedParams:o}})}}function vc(e){if(W){const{roi:t,imageData:o}=e.detail;log("eventBinder","info",`Recebido evento para processar dados da ROI ID: ${t.id}. Enviando para o worker.`),W.postMessage({type:"processRoiData",payload:{roi:t,imageData:o}},[o.data.buffer])}}function bc(e){if(W){const{imageData:t,settings:o}=e.detail;log("eventBinder","info","Recebido evento para detectar círculos. Enviando para o worker."),Ze("Detectando ROIs na imagem..."),W.postMessage({type:"detectCircles",payload:{imageData:t,settings:o}},[t.data.buffer])}}function xc(){if(log("eventBinder","info","Disparando cálculo de métricas no Web Worker..."),!W){R("O módulo de cálculo não está pronto.");return}const e=b();if(!e||e.length===0){R("Crie pelo menos uma ROI para calcular as métricas.");return}const t=ge();if(!t){R("Erro: Imagem não encontrada para processamento.");return}const n=t.getContext("2d").getImageData(0,0,t.width,t.height);Ze("Calculando métricas em segundo plano...");const a=e.find(i=>i.id===w());W.postMessage({type:"calculateMetrics",payload:{allRois:e,whiteRoi:a,imageData:n}},[n.data.buffer])}function Ic(e){const t=e.target.closest(".accordion-header");if(t){log("eventBinder","info","Manipulando clique em menu sanfona (accordion)."),e.stopPropagation();const o=t.nextElementSibling,n=t.querySelector(".accordion-icon");if(o&&n){const a=o.classList.contains("hidden");t.classList.toggle("expanded",a),o.classList.toggle("hidden",!a),n.classList.toggle("rotate-90",a)}}}function Ec(e){const t=e.target.closest(".sample-description-display");if(t){e.stopPropagation();const n=parseInt(t.dataset.roiId,10),a=b().find(i=>i.id===n);a&&Ps("Editar Descrição da Amostra",a.sampleDescription).then(i=>{a.sampleDescription=i,Bs()}).catch(i=>log("eventBinder","info","Edição de descrição de amostra cancelada.",i));return}const o=e.target.closest(".toggle-details-btn");if(o){e.stopPropagation();const n=o.closest(".sample-main-row");if(n){const a=n.nextElementSibling;if(a&&a.matches(".sample-detail-row")){const i=a.classList.contains("hidden");a.classList.toggle("hidden",!i),o.classList.toggle("expanded",i)}}}}function Sc(e){const t=e.target;if(!t.matches('input[type="number"]'))return;const o=parseInt(t.dataset.roiId,10),n=b().find(u=>u.id===o);if(!n)return;const a=t.value.trim(),i=a===""?null:parseFloat(a.replace(",","."));if(a!==""&&isNaN(i)){t.value=n.concentration??"",ue("Por favor, insira um valor numérico válido.");return}n.concentration=i;const s=document.getElementById("calibrationSetupTable");if(!s)return;const r=s.querySelector(`.calibration-checkbox[data-roi-id="${o}"]`);if(!r)return;const l=i!==null;r.disabled=!l,r.checked=l,n.useInCalibration=l,ln()}function Rc(e){const t=e.target.closest(".calibration-checkbox");if(!t)return;const o=parseInt(t.dataset.roiId),n=b().find(a=>a.id===o);if(n)if(n.useInCalibration=t.checked,t.checked&&n.concentration===null){log("eventBinder","info",`Inclusão manual de ROI ${o}. Verificando fila de concentração.`);const a=b().filter(r=>r.calibrationOrder!==null).sort((r,l)=>r.calibrationOrder-l.calibrationOrder),i=a.findIndex(r=>r.id===o);if(i===-1)return;const s=a.slice(i).filter(r=>r.concentration===null).map(r=>r.id);s.length>0&&(log("eventBinder","data",`Fila de concentração criada com ${s.length} item(s).`,s),Ia(s),$s())}else log("eventBinder","info",`ROI ${o} teve seu estado de inclusão alterado para ${t.checked}. Atualizando UI.`),ln()}async function Cc(e){const t=e.target.files[0];if(!t)return;log("eventBinder","info","Manipulando upload de imagem:",t.name,t.type),De.textContent=`Carregando: ${t.name}`;const o=await Xs(t);o.success?(De.textContent=o.fileName,H()):(R(o.message),De.textContent="Nenhum arquivo"),e.target.value=null}async function Mc(){if(tn())try{await Za("Excluir Imagem","Tem certeza que deseja excluir a imagem atual? Todas as ROIs e análises serão perdidas."),log("eventBinder","warn","Usuário confirmou a exclusão da imagem."),lc()}catch{log("eventBinder","info","Exclusão de imagem cancelada pelo usuário.")}}function Bc(e){const t=e.target.closest(".roi-card");if(!t)return;const o=parseInt(t.dataset.roiId,10);if(e.target.closest(".edit-name-button-class")){e.stopPropagation(),log("eventBinder","info",`Botão 'Editar Nome' clicado para ROI ${o}.`),il(o).then(()=>na()).catch(a=>log("eventBinder","info","Edição de nome de ROI cancelada.",a));return}const n=e.target.closest(".expand-details-button");if(n){e.stopPropagation();const a=b().find(i=>i.id===o);if(a){a.isDetailsExpanded=!a.isDetailsExpanded,log("eventBinder","info",`Detalhes da ROI ${o} alterados para expandido: ${a.isDetailsExpanded}.`);const i=t.querySelector(".roi-card-details");i&&i.classList.toggle("hidden",!a.isDetailsExpanded),n.textContent=a.isDetailsExpanded?"▼":"▶"}return}log("eventBinder","info",`Card da ROI ${o} clicado para seleção.`),e.shiftKey||e.ctrlKey||J()?qi(o):(Ie(),Ke(o)),oa()}function Lc(){Xi(),log("eventBinder","info",`Lupa alterada para: ${Yt()?"habilitada":"desabilitada"}.`),kt()}function wc(){Er(),log("eventBinder","info",`Trava de visualização alterada para: ${on()?"travado":"destravado"}.`),kt()}async function kc(){const e=ir();if(!e){log("eventBinder","warn","Tentativa de instalação do PWA, mas o prompt não estava disponível.");return}log("eventBinder","info","Exibindo prompt de instalação do PWA."),e.prompt();try{const{outcome:t}=await e.userChoice;log("eventBinder","info",`Resultado do prompt de instalação do PWA: ${t}.`),t==="accepted"&&Le&&(Le.textContent="App instalado!")}catch(t){log("eventBinder","error","Erro durante o prompt de instalação do PWA.",t)}Ea(null),me&&(me.style.display="none")}function Ac(e){e.preventDefault(),Ea(e),log("eventBinder","info","Evento 'beforeinstallprompt' capturado. App pode ser instalado."),me&&(me.style.display="block"),Le&&Le.classList.remove("hidden")}function $c(){log("eventBinder","info","Evento 'appinstalled' detectado. O PWA foi instalado com sucesso."),me&&(me.style.display="none"),Le&&Le.classList.add("hidden"),Ea(null)}function Pc(e){const t=e.target.checked;if(log("eventBinder","info",`Checkbox 'Incluir todos para calibração' alterado para: ${t}.`),!document.getElementById("calibrationSetupTableBody"))return;const n=[];b().filter(i=>i.calibrationOrder!==null).sort((i,s)=>i.calibrationOrder-s.calibrationOrder).forEach(i=>{i.useInCalibration=t,t&&i.concentration===null&&n.push(i.id)}),n.length>0?(log("eventBinder","info",`Iniciando fila de concentração para ${n.length} ROIs.`),Ia(n),$s()):(Ja(),ln())}function Tc(e){const t=normalizeText(e.target.value.trim());if(!O)return;if(!t){log("eventBinder","info","Busca limpa. Restaurando visualização padrão do seletor de sinais."),Ka();return}const o=[];for(const n in analyticalEquationsBySystem){const a=analyticalEquationsBySystem[n];for(const i in a)a[i].forEach(r=>{const l=`SA (${n} - ${r.text})`;normalizeText(`${r.text} ${r.fullName} ${n} ${i}`).includes(t)&&o.push({equation:r,systemName:n,groupName:i,channelName:l})})}log("eventBinder","info",`Buscando por: "${e.target.value.trim()}". Encontrados ${o.length} resultados.`),Pr(o,e.target.value.trim())}function Mi(e){if(!O)return;log("eventBinder","info",`Marcando sinais visíveis como: ${e}.`),O.querySelectorAll('input[type="checkbox"]').forEach(o=>{o.offsetParent!==null&&(o.checked=e)}),we()}function Dc(){O&&(log("eventBinder","info","Marcando todos os sinais."),O.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.checked=!0}),we())}function Oc(){O&&(log("eventBinder","info","Limpando todas as seleções de sinais."),O.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.checked=!1}),we())}function Nc(){log("eventBinder","info","Abrindo o Painel de Seleção de Sinais."),Ka(),Ue&&(Ue.dataset.visible="true")}function Bi(){Ue&&(Ue.dataset.visible="false",Zt&&(Zt.value=""),log("eventBinder","info","Fechando e restaurando o Painel de Seleção de Sinais."),Ka())}function qc(e){const t=e.target.value;if(!t)return;log("eventBinder","info",`Modo de visualização da regressão alterado para: ${t}`),mr(t);const o=D();o.length>0&&(typeof CHART_STYLES<"u"?Po(o,CHART_STYLES):log("eventBinder","error","CHART_STYLES não está disponível para re-renderização."))}function Li(e){const{target:t}=e;if(t.matches(".regression-visibility-toggle")){const n=t.dataset.paramName;if(!n)return;pr(n),Po(D(),CHART_STYLES);return}const o=n=>{hr(n),Po(D(),CHART_STYLES)};if(t.matches("#apply-regression-limit")){const n=U.querySelector("#regression-limit-input");n&&o(n.value);return}if(t.matches(".limit-shortcut-btn")){const n=t.dataset.limit;n&&o(n);return}if(e.type==="keyup"&&e.key==="Enter"&&t.matches("#regression-limit-input")){o(t.value);return}}function Fc(e){const t=e.target.closest("#qualityControlPanelContainer .accordion-header");if(t){e.stopPropagation(),Sr();const a=t.nextElementSibling,i=t.querySelector(".accordion-icon"),s=Ni();a&&i&&(a.classList.toggle("hidden",!s),i.classList.toggle("rotate-90",s));return}if(e.target.closest("#quality-panel-info-button")){if(e.stopPropagation(),log("eventBinder","info","Botão de informações do painel de qualidade clicado."),typeof QUALITY_PARAMETERS_INFO<"u"){const a=Object.values(QUALITY_PARAMETERS_INFO);rl("Parâmetros de Qualidade do Modelo",a)}else log("eventBinder","error","Objeto QUALITY_PARAMETERS_INFO não foi encontrado para exibir o modal."),R("Erro: As definições dos parâmetros de qualidade não foram carregadas.");return}const n=e.target.closest("th[data-sort-by]");if(n){const a=n.dataset.sortBy;let i="desc";ca.key===a?i=ca.direction==="asc"?"desc":"asc":(a==="lod"||a==="loq"||a==="Syx")&&(i="asc"),ca={key:a,direction:i},log("eventBinder","info",`Solicitada ordenação da tabela de qualidade por: ${a}, direção: ${i}.`);const s=n.closest("table").querySelector("tbody");if(!s)return;const r=Array.from(s.querySelectorAll("tr"));r.sort((u,g)=>{var h,x;const c=(E,I)=>{const M=E.children[I];if(!M)return null;const S=M.textContent;return S==="—"||S==="N/D"?null:parseFloat(S)},f={parameter:0,r2:2,sensitivity:3,Syx:4,lod:5,loq:6}[a];if(f===void 0)return 0;if(a==="parameter"){const E=((h=u.children[f])==null?void 0:h.textContent)||"",I=((x=g.children[f])==null?void 0:x.textContent)||"";return i==="asc"?E.localeCompare(I):I.localeCompare(E)}const p=c(u,f),y=c(g,f);return p===null?1:y===null?-1:i==="asc"?p-y:y-p}),r.forEach(u=>s.appendChild(u)),n.closest("thead").querySelectorAll("th[data-sort-by]").forEach(u=>{const g=u.textContent.replace(/ [↓↑]/,"");u.textContent=g});const l=i==="asc"?"↑":"↓";n.textContent+=` ${l}`}}function zc(){if(log("eventBinder","info","Vinculando todos os event listeners da aplicação."),window.Worker){log("eventBinder","info","Web Worker suportado. Instanciando worker clássico.");try{W=new Worker("/js/calculation.worker.js"),W.onmessage=hc,W.onerror=n=>{log("eventBinder","error","Erro não tratado no Web Worker:",n),R(`Ocorreu um erro fatal no worker de cálculo: ${n.message}`)}}catch(n){log("eventBinder","error","Falha ao instanciar o CalculationWorker.",n)}}else log("eventBinder","error","Web Workers não são suportados neste navegador."),R("Seu navegador não suporta Web Workers, uma tecnologia essencial para este aplicativo.");window.addEventListener("generate-regressions",yc),window.addEventListener("process-roi-data",vc),window.addEventListener("request-circle-detection",bc),window.addEventListener("appinstalled",$c),window.addEventListener("beforeinstallprompt",Ac),window.addEventListener("click",n=>{n.target===Xe&&Oo(!1),n.target===je&&Do(),$e&&!$e.classList.contains("hidden")&&!La.contains(n.target)&&$e.classList.add("hidden"),Kt&&j().visible&&!Kt.contains(n.target)&&(tt(),kt())}),In&&In.addEventListener("change",Cc),ie&&ie.addEventListener("click",()=>_e("rect")),se&&se.addEventListener("click",()=>_e("circle")),Re&&Re.addEventListener("click",()=>_e("pointer")),Sn&&Sn.addEventListener("click",ks),Ut&&Ut.addEventListener("click",Kr),En&&En.addEventListener("click",()=>_r()),vt&&vt.addEventListener("click",()=>{const n=$();n.size===1&&yi(n.values().next().value)}),Xt&&Xt.addEventListener("click",tl),jt&&jt.addEventListener("click",nl),Qt&&Qt.addEventListener("click",()=>{const n=$(),a=n.size>0?n:null;ti(a)}),((n,a)=>{if(!n)return;let i=!1,s=1;n.addEventListener("input",l=>{i=!0;const u=l.target.value,g=parseFloat(u)/100,c=g/s;Wr(c),s=g,a&&(a.textContent=`${u}%`),A()});const r=()=>{i&&(log("eventBinder","info","Slider de redimensionamento liberado. Solicitando recálculo de dados."),ea()),n.value=100,s=1,a&&(a.textContent="100%"),i=!1};n.addEventListener("mouseup",r),n.addEventListener("touchend",r)})(Ma,Ba),Pn&&Pn.addEventListener("click",()=>{j().roiId&&Xr(j().roiId),tt()}),$n&&$n.addEventListener("click",()=>{j().roiId&&Qr(j().roiId),tt()}),Fe&&Fe.addEventListener("click",()=>{j().roiId&&yi(j().roiId),tt()}),Jt&&Jt.addEventListener("click",()=>{j().roiId&&el(j().roiId),tt()}),yt&&yt.addEventListener("click",jr),Tn&&Tn.addEventListener("click",n=>{n.target.classList.contains("tab-button")&&gl(n.target.dataset.tab)}),be&&be.addEventListener("click",Bc),uo&&uo.addEventListener("click",Nc),Ue&&(Na.addEventListener("click",Bi),qa.addEventListener("click",()=>{we(),Bi()}),Zt.addEventListener("input",Tc),go&&go.addEventListener("click",Dc),mo&&mo.addEventListener("click",()=>Mi(!0)),fo&&fo.addEventListener("click",()=>Mi(!1)),po&&po.addEventListener("click",Oc),O.addEventListener("click",Ic),O.addEventListener("click",n=>{const a=n.target.closest(".metric-info-icon");if(a){n.preventDefault(),n.stopPropagation();const i=a.dataset.metricId;i&&(log("eventBinder","info",`Ícone de informação clicado para a métrica ID: ${i}`),sl(i))}}),O.addEventListener("input",n=>{n.target.matches('input[type="checkbox"]')&&we()}));const t=document.getElementById("calibrationTableWrapper");t&&(t.addEventListener("input",Sc),t.addEventListener("click",Rc),t.addEventListener("change",n=>{n.target.matches("#selectAllForCalibration")&&Pc(n)}),t.addEventListener("dragstart",n=>{const a=n.target.closest(".calibration-row");a&&(log("eventBinder","info",`Iniciando arraste da linha ROI ID: ${a.dataset.roiId}`),T=a,setTimeout(()=>{T&&T.classList.add("dragging")},0))}),t.addEventListener("dragover",n=>{n.preventDefault();const a=n.target.closest(".calibration-row");if(!a||!T||a===T)return;t.querySelectorAll(".calibration-row").forEach(r=>{r.classList.remove("drag-over-top","drag-over-bottom")});const i=a.getBoundingClientRect(),s=n.clientY>i.top+i.height/2;a.classList.toggle("drag-over-bottom",s),a.classList.toggle("drag-over-top",!s)}),t.addEventListener("dragleave",n=>{const a=n.target.closest(".calibration-row");a&&a.classList.remove("drag-over-top","drag-over-bottom")}),t.addEventListener("dragend",()=>{T&&T.classList.remove("dragging"),t.querySelectorAll(".calibration-row").forEach(n=>{n.classList.remove("drag-over-top","drag-over-bottom")}),T=null}),t.addEventListener("drop",n=>{n.preventDefault();const a=n.target.closest(".calibration-row");if(a&&a.classList.remove("drag-over-top","drag-over-bottom"),T&&T.classList.remove("dragging"),!T||!a||a===T){T=null;return}const i=parseInt(T.dataset.roiId,10),s=parseInt(a.dataset.roiId,10),r=b(),l=r.find(c=>c.id===i),u=r.find(c=>c.id===s);if(!l||!u){log("eventBinder","error","Não foi possível encontrar uma das ROIs para a troca (swap)."),T=null;return}log("eventBinder","info",`Trocando ordem entre ROI ID ${i} e ROI ID ${s}.`);const g=l.calibrationOrder;l.calibrationOrder=u.calibrationOrder,u.calibrationOrder=g,log("eventBinder","data",`Estado trocado: ROI ${l.id} agora tem ordem ${l.calibrationOrder}.`),log("eventBinder","data",`Estado trocado: ROI ${u.id} agora tem ordem ${u.calibrationOrder}.`),Ja(),ln(),T=null})),Nn&&Nn.addEventListener("click",xc),qn&&qn.addEventListener("click",Nr),It&&It.addEventListener("click",Ls),Fn&&Fn.addEventListener("click",Jr),Dn&&Dn.addEventListener("change",n=>{_i(n.target.value),ta()}),Rt&&Rt.addEventListener("click",Fc),He&&He.addEventListener("change",qc),U&&(U.addEventListener("click",Li),U.addEventListener("keyup",Li)),St&&St.addEventListener("click",Jl),Et&&Et.addEventListener("click",tc),ft&&ft.addEventListener("click",Mc),pt&&pt.addEventListener("click",Dl),ht&&ht.addEventListener("click",Ol),Oe&&Oe.addEventListener("click",n=>{n.stopPropagation(),$e.classList.toggle("hidden")});const o=()=>$e.classList.add("hidden");Cn&&Cn.addEventListener("click",n=>{n.preventDefault(),Rl(),o()}),Mn&&Mn.addEventListener("click",n=>{n.preventDefault(),kl(),o()}),Bn&&Bn.addEventListener("click",n=>{n.preventDefault(),Sl(),o()}),Ln&&Ln.addEventListener("click",Ll),wn&&wn.addEventListener("click",Wt),q&&q.addEventListener("click",()=>{z()==="sequencingRois"?oi():Wt()}),Ct&&Ct.addEventListener("click",gc),le&&le.addEventListener("click",mc),me&&me.addEventListener("click",kc),Gt&&Gt.addEventListener("click",n=>{n.preventDefault(),Ps("Identificação da Análise",We()).then(a=>{Gi(a),Gt.innerHTML=a?`<span class="text-gray-800">${a}</span>`:'<span class="text-gray-400 italic">Clique para definir um título...</span>';const i=Ge();i&&i.options.plugins.title&&(i.options.plugins.title.text=a,i.options.plugins.title.display=!!a,i.update("none"))}).catch(a=>log("eventBinder","info","Edição de nome de amostra cancelada.",a))}),ze&&ze.addEventListener("click",Ec),Ne&&Ne.addEventListener("click",pc),bt&&bt.addEventListener("click",Lc),xt&&xt.addEventListener("click",wc),no&&no.addEventListener("click",()=>{fn(Ei.title,Ei.htmlContent)}),oo&&oo.addEventListener("click",()=>{fn(Si.title,Si.htmlContent)}),ao&&ao.addEventListener("click",()=>{fn(Ri.title,Ri.htmlContent)}),Rn&&Rn.addEventListener("click",()=>{fn(Ci.title,Ci.htmlContent)}),Ks(),rc()}document.addEventListener("DOMContentLoaded",()=>{Ms(),log("main","info","Aplicação iniciada. Evento DOMContentLoaded disparado."),Lo&&(Lo.textContent=new Date().getFullYear()),Ul(),cn(),zc(),Jo(),ec(),_e("pointer"),ul(),log("main","info","Todos os módulos foram inicializados com sucesso. Aplicação pronta.")});
